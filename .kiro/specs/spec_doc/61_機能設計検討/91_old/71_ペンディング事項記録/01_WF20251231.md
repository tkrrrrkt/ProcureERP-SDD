# ProcureERP：WF仕様（固定Seat方式）備忘・ペンディング事項

> 目的：本格実装・機能設計・運用設計に進む前に、未確定事項／後続検討事項を明示する。

---

## 1. 伝票側の制御（WF外だが密接）

### 1.1 「下流影響（Downstream Impact）」の仕様確定（重要）

- 背景：Draftのみ削除可、Submitted以降は削除不可（承認ON時）。  
    承認OFFでも「下流影響が発生したら削除不可」方針。
    
- 要検討：下流影響の判定基準
    
    - PR：PO派生、注文書発行/送信、外部連携、GR/Invoice/仕入計上等
        
    - PO：送信済、入荷/請求照合、支払確定等
        
- 成果物：
    
    - 伝票種別ごとの「削除可否・取消可否・Close可否」状態遷移表
        
    - downstream_status（語彙）と更新タイミング
        

---

## 2. WF高度化（将来拡張の設計確定ポイント）

### 2.1 条件分岐の拡張

- 現状（確定）：MVPは金額閾値のみ
    
- 追加候補：セグメント／カテゴリ／部門／プロジェクト／緊急フラグ
    
- 要検討：条件の論理（AND/OR）、優先度、同点時ルール
    

### 2.2 manager_chain（垂直承認：上位者チェーン）

- 現状：方式（エンティティ）だけ用意
    
- 要検討：
    
    - 上長データの正本（employees.manager / employee_assignments.manager 等）
        
    - 何段まで生成するか、金額閾値との組合せ
        

### 2.3 並列承認・合議

- 現状：is_parallelは将来
    
- 要検討：
    
    - 並列時の完了条件（全員承認／過半数／誰か1人）
        
    - 監査・差戻し・取消時の扱い
        

### 2.4 期限・督促・エスカレーション

- 要検討：
    
    - 承認期限（SLA）
        
    - リマインド通知
        
    - 期限超過時の自動エスカレーション（上位席へ、購買管理者へ等）
        

### 2.5 都度委任（approval_task_delegations）の運用

- 現状：エンティティのみ用意、MVP運用しない
    
- 要検討：
    
    - 委任可能条件（pendingのみ、理由必須等）
        
    - 委任後の責任主体の扱い（監査・説明）
        

---

## 3. 取消（決裁取り消し）の厳密化

- 現状（確定）：同ルートでcancel purposeのWFを回す
    
- 要検討：
    
    - 取消の可否条件（Approvedのみ、送信済や実績ありの場合の制限）
        
    - 取消の結果（Canceled vs Closed の語彙整理）
        
    - 取消理由コード（マスタ化）
        

---

## 4. 監査ログ（audit_logs）

- 現状：Draft削除は「伝票deleted_*」＋「audit_logs」併用方針
    
- 要検討：
    
    - audit_logsの必須イベント一覧（submit/approve/reject/return/cancel_submit/cancel_approve/delete 等）
        
    - details_jsonに保持すべき情報（旧→新、コメント、Seat情報）
        
    - ログ保持期間・エクスポート要件
        

---

## 5. 設定運用（管理機能）

- Seat未設定は申請不可（確定）
    
- 要検討：
    
    - 設定チェック（どの伝票種別×金額レンジでSeatが不足するか）
        
    - CSV取込のフォーマット（department_approver_slots / delegations）
        
    - “設定変更”の監査と適用タイミング（将来の有効日）