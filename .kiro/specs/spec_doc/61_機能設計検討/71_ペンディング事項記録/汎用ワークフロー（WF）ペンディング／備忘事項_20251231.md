# ProcureERP：汎用ワークフロー（WF）ペンディング／備忘事項

本ドキュメントは、ProcureERP の汎用WFに関して **現時点で確定しない事項／後続検討事項** を体系的に棚卸しした正本である。  
本書に記載の内容は **Spec Freeze の対象外** とし、「決めない」ことを明確にすることで、次フェーズでの検討漏れ・設計事故を防止する。

---

## 1. 下流影響（Downstream Impact）仕様（重要）

### 仕様の概要

- WF仕様では「Draftのみ削除可」「submit後削除不可」を確定している。
    
- ただし現実の購買業務では、伝票は下流に派生（PO / GR / AP / ERP連携 等）する。
    
- その結果、取消（Cancel）・Close・修正の可否は **WFではなく伝票制御（業務ルール）** として整理する必要がある。
    

### 検討ポイント

- PR：PO派生後の取消可否（PR取消時に下流POをどう扱うか）
    
- PO：送信済／入荷済／請求済の段階別取消可否
    
- GR / AP：実績発生後の修正・取消手段
    
    - GR：訂正履歴方式
        
    - AP：赤黒方式
        
- Close（業務完了）と Canceled（承認取消）の語彙整理
    
- downstream_status の定義と更新タイミング
    

### 成果物（予定）

- 伝票種別ごとの状態遷移表（削除／取消／Close）
    
- downstream_status の定義書
    

---

## 2. 条件拡張（承認ルート条件の拡張）

### 仕様の概要

- MVPでは金額閾値（min_amount）のみを承認条件として確定している。
    
- 将来、購買統制強化のために条件拡張が想定される。
    

### 検討ポイント

- セグメント（費目／カテゴリ）条件
    
- プロジェクト条件
    
- 取引先区分（重要仕入先）
    
- 緊急フラグ（例外ルート）
    
- AND / OR 条件、条件優先順位
    

### 成果物（予定）

- approval_route_conditions 拡張設計
    
- 条件入力UI仕様（条件ビルダー等）
    

---

## 3. manager_chain（垂直承認ロジックの高度化）

### 仕様の概要

- 現行WFでは Seat（self / ancestor / fixed）指定により上位承認を表現可能。
    
- ただし、申請者の「上長チェーン」を動的に辿る manager_chain 方式は未導入。
    

### 検討ポイント

- 上長データの正本（employees.manager 等）
    
- 何段まで生成するか
    
- 金額条件との組合せ
    
- 兼務・代理・組織改編時の整合性
    

---

## 4. 並列承認・合議（is_parallel）

### 仕様の概要

- 現行WFは逐次承認（Step1 → Step2 → …）のみ。
    

### 検討ポイント

- 並列承認（複数承認者同時）
    
- 合議条件（全員／過半数 等）
    
- 差戻・却下時の扱い
    
- 監査ログの粒度
    

---

## 5. 承認期限・督促・エスカレーション

### 仕様の概要

- MVPでは承認期限・督促は未実装。
    

### 検討ポイント

- 承認期限（SLA）
    
- リマインド通知（メール／Slack／Teams）
    
- 期限超過時の自動エスカレーション
    
- 営業日カレンダー連携
    

---

## 6. 都度委任（approval_task_delegations）運用

### 仕様の概要

- エンティティは用意済だが、MVPでは運用しない。
    

### 検討ポイント

- 委任可能条件（pendingのみ 等）
    
- 理由必須化
    
- 委任後の責任主体
    
- 委任取消の扱い
    

---

## 7. RFQ取消の詳細制御

### 仕様の概要

- RFQは cancel_enabled=true。
    
- **QUOTEが1件でも存在した場合は取消不可**（確定）。
    

### 検討ポイント

- 取消不可時の代替（Withdrawn / Close）
    
- 仕入先通知要否
    
- 取消理由コードのマスタ化
    

---

## 8. AP赤黒（会計・外部連携含む）詳細設計

### 仕様の概要

- APは Cancel ではなく赤黒方式を採用（確定）。
    

### 検討ポイント

- ap_group_id 採番・管理方式
    
- reversal / corrected の参照関係
    
- ERP連携手順
    
- 税・端数・インボイス制度対応
    
- 監査証跡（訂正理由・承認者）
    

---

## 9. 設定運用（管理機能）と健全性チェック

### 仕様の概要

- Seat未設定は申請不可とするが、事前検知が望ましい。
    

### 検討ポイント

- ルート／Step／Seat 不足チェック
    
- CSV取込フォーマット
    
- 設定変更の監査ログ
    
- 将来有効日運用
    

---

## 10. 監査・レポーティング

### 仕様の概要

- 監査ログの記録自体は確定している。
    

### 検討ポイント

- 承認滞留分析
    
- 差戻・取消統計
    
- CSV / PDF 出力
    
- 保持期間・アーカイブ
    

---

## 11. ロール承認（role_owner）決定性ルール

### 仕様の概要

- Seatの承認者指定に role_owner を利用可能。
    
- ロール保有者が複数存在する場合の扱いは未確定。
    

### 検討ポイント

- ロール保有者0名／複数名時の挙動
    
- 並列承認への拡張可否
    

### 暫定方針（検討案）

- MVPでは **ロール保有者が1名でなければ申請不可**。
    
- 並列承認は将来拡張。
    

---

## 12. cancel purpose における min_amount=0 ルート

### 仕様の概要

- approve と同様に cancel にも金額閾値ルートを適用するかは未確定。
    

### 検討ポイント

- cancel でも min_amount=0 を必須とするか
    

### 暫定方針（検討案）

- cancel purpose でも **min_amount=0 ルートを必須**。
    
- MVPでは approve と同一構成。
    

---

## 13. Seat／代理の有効日判定基準

### 仕様の概要

- Seat / 代理には有効期間を持たせている。
    

### 検討ポイント

- submit時点基準か承認時点基準か
    

### 暫定方針（検討案）

- **submitted_at（申請時点）基準**。
    
- submit後は Task を固定。
    

---

## 14. organization_version_id と ancestor 参照の整合性

### 仕様の概要

- ancestor(n) による上位部門参照が存在する。
    

### 検討ポイント

- 組織改編後の過去申請の再現性
    

### 暫定方針（検討案）

- submit時点の organization_version_id を正本とする。
    
- ancestor参照は当該組織版を使用。
    

---

## 15. 承認ログ（approval_actions）と監査ログ（audit_logs）の役割分担

### 仕様の概要

- 承認操作ログと監査ログが二重に存在する。
    

### 検討ポイント

- 二重記録による不整合リスク
    

### 暫定方針（検討案）

- 承認操作の正本は approval_actions。
    
- audit_logs は参照IDのみ保持。
    

---

## 16. 承認中の組織・Seat・権限変更の扱い

### 仕様の概要

- 承認中に組織改編・Seat変更が起きうる。
    

### 検討ポイント

- 既存Taskの差し替え可否
    

### 暫定方針（検討案）

- submit時点で生成されたTaskは最後まで固定。
    

---

## 17. 同一人物による連続承認の扱い（将来拡張）

### 仕様の概要

- 同一人物が複数Stepに登場するケースがある。
    

### 検討ポイント

- 自動スキップ可否
    

### 暫定方針（検討案）

- MVPではスキップしない。
    
- 将来拡張余地を残す。
    

---

## 18. Cancel と Close の語彙・運用整理

### 仕様の概要

- Cancel と Close を明確に分けている。
    

### 検討ポイント

- 伝票別の適用可否
    

### 暫定方針（検討案）

- Cancel は原則WFを伴う。
    
- Close は業務操作として扱う。
    

---

（以上）