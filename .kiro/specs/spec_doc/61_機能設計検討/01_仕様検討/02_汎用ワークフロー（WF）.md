
# 汎用ワークフロー（WF） 仕様概要

本ドキュメントは、ProcureERP における汎用ワークフロー（WF）の**仕様凍結（Spec Freeze）宣言**である。  
本書に記載された内容は、以後の設計・実装・テスト・UI/UX検討において**前提条件として固定**し、変更が生じる場合は明示的な変更管理（ADR / 仕様変更チケット）を必須とする。

---

## 1. 基本思想（不変）

1. WFは **固定WF方式**（Fixed Workflow）とする  
   - submit（申請）時点で「適用ルート」「段構成」「各段の承認者（Task assignee）」を確定し固定  
   - 承認途中に条件再評価・ルート変更・承認者再解決は行わない

2. 承認責務は **Seat（部門×段）** に帰属する  
   - 承認者は「人」ではなく「席（Seat）」として管理する  
   - 同一人物が複数段を兼務しても、段（責務）は省略しない（スキップしない）

3. 代理承認は **Seat代理（事前登録）** を正本とする  
   - 都度委任はエンティティのみ用意し、MVP運用はしない

4. Seat未設定は **申請不可（エラー）** とする  
   - 自動フォールバックや自動エスカレーションで業務を進めない（統制優先）

5. 金額条件は **min_amount（〇円以上）閾値方式**とする  
   - 税抜金額で評価  
   - 同一 document_type × purpose 内で min_amount 重複禁止  
   - **min_amount=0 のルートは必須**  
   - 実行時は「min_amount 最大が勝つ」

6. 差戻（Return）は Draft戻し＋再申請時にWF再生成  
   - 既存WFインスタンスは終了扱い（canceled）

7. Cancel（決裁取り消し）は purpose=cancel のWFとして扱う（PR/PO/RFQ）  
   - cancelルートは approve と同一ロジックを適用可能（MVPは同一で運用）

8. AP（仕入計上）は **赤黒方式**で訂正・取消を表現し、Cancel WF は使用しない  
   - original / reversal / corrected  
   - それぞれ別採番  
   - reversal（赤）承認完了をもって取消成立

---

## 2. document_types（正本）

以下の 6 種を WF / 伝票設計の正本とする。

- PR（購買依頼）
- RFQ（見積依頼）
- QUOTE（見積回答）
- PO（発注）
- GR（受入・検収）
- AP（仕入計上）

承認ON/OFF と Cancel方針は下表のとおり確定する。

|伝票|承認（approve）|取消（cancel WF）|備考|
|---|---|---|---|
|PR|ON|ON|購買統制の起点|
|RFQ|ON|ON|**QUOTEが1件でも付いたら取消不可**／cancelルートはapproveと同一|
|QUOTE|OFF|—|受領データ（承認対象外）|
|PO|ON|ON|対外コミット（重要）|
|GR|OFF|—|実績入力（承認対象外）|
|AP|ON|OFF|赤黒方式で訂正・取消（Cancel WFは使用しない）|

---

## 3. エンティティ凍結対象（WF領域）

本Spec Freezeは、WF領域として以下エンティティ群の存在と役割を凍結する（詳細仕様は 01_WF_Spec.md を正本とする）。

- document_types
- approval_routes
- approval_route_conditions（min_amount）
- approval_route_steps（Seat参照：self/ancestor/fixed + slot_level_no）
- department_approver_slots（Seat定義）
- department_approver_delegations（Seat代理：事前登録）
- approval_instances（purpose=approve/cancel）
- approval_tasks（submit時 assignee確定）
- approval_actions（承認操作ログ）
- approval_task_delegations（都度委任ログ：将来運用）
- audit_logs（汎用監査ログ：Draft削除含む）

---

## 4. 変更管理

- Spec Freeze内容を変更する場合は、必ず ADR（設計判断記録）を起票し、影響範囲（データ移行／互換性／既存伝票への影響）を明記する。

（以上）
