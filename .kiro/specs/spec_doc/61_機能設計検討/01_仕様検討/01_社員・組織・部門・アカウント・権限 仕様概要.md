# 社員・組織・部門・アカウント・権限 仕様概要

> 本ドキュメントは、**購買管理SaaS（ProcureERP）における共通基盤**として、社員・組織・部門・所属履歴・アカウント・権限の仕様概要を定義する。
>
> エンティティの詳細定義は `02_エンティティ定義/01_社員・組織・部門・アカウント・権限.md` を参照。

---

## 1. 対象範囲

本仕様が対象とするエンティティ:

1. **employees**（社員）- 「人」を表す基本マスタ
2. **employee_assignments**（社員所属履歴）- 所属部門・主務/兼務・役割の期間管理
3. **organization_versions**（組織バージョン）- 組織構造のスナップショット管理
4. **departments**（部門）- 組織版内の部門実体
5. **login_accounts**（ログインアカウント）- ログイン・認証・セキュリティ専用
6. **roles**（ロール）- 機能単位の役割定義
7. **login_account_roles**（アカウントロール付与）- アカウントへの複数ロール付与

---

## 2. 設計の基本方針

### 2.1 マルチテナントSaaS前提

- **tenant_id を唯一のテナント境界**とする（CompanyIDは持たない）
- 全テーブルでRLS (Row Level Security) を有効化
- アプリケーション層とRLSによる二重ガード

### 2.2 社員とアカウントの分離

- **社員（employees）** = 「人」を表す
  - 異動・兼務・役職・承認責務は保持しない（履歴テーブルで管理）
- **アカウント（login_accounts）** = 「認証主体」を表す
  - 社員との1:1関係（UNIQUE(tenant_id, employee_id)）
  - SSO対応（auth_provider: local/oidc/saml）

### 2.3 組織改編耐性

- **組織バージョン管理**（organization_versions）でスナップショットを保持
- **department_stable_id**（版非依存ID）により、組織改編を跨いだ追跡が可能
- 申請・承認時点の組織を再現可能にすることで、説明責任・監査対応を実現

### 2.4 権限管理

- **RBAC（ロールベース）**を最小構成で実装
- 購買特有の制御（承認上限等）は後続エンティティ（approval_routes等）で拡張

---

## 3. employees（社員）仕様概要

### 3.1 目的

購買依頼・承認フローにおける「人」の管理。人事マスタが外部に存在しても、購買承認・責任追跡のため本エンティティは必須。

### 3.2 主要属性

| 属性カテゴリ | 属性 | 必須 | 備考 |
|------------|------|------|------|
| **識別子** | employee_code | ◯ | 業務コード（テナント内一意、varchar(30)） |
| **基本情報** | employee_name | ◯ | 氏名 |
|  | employee_name_kana | ◯ | カナ名（MVP-1では必須、検索・ソート用） |
|  | email | | 連絡用（任意） |
| **雇用期間** | join_date | | 入社日 |
|  | retire_date | | 退職日（任意） |
| **補足** | remarks | | 備考（任意） |
| **制御** | is_active | ◯ | 論理無効フラグ |
|  | version | ◯ | 楽観ロック |
| **監査** | created_by_login_account_id | | 作成者（login_accounts.id） |
|  | updated_by_login_account_id | | 更新者（login_accounts.id） |

### 3.3 命名の根拠

**Q: なぜ `join_date` / `retire_date` なのか？**

- **`hire_date` / `leave_date`（雇用関係の開始/終了）** との比較検討を実施
- 結論: **日本の購買管理SaaSとしては `join_date` / `retire_date` が自然**
  - `hire_date` は「雇用日」で契約日のニュアンスが強い
  - `join_date` は「入社日」で実際に働き始めた日を表す
  - 購買申請・承認では「いつから組織メンバーか」が重要 → `join_date` が適切
- 実装が先行しており、動作確認済み
- 国際化の観点でも問題なし

### 3.4 employee_name_kana の必須性（MVP-1方針）

**背景**: 国際化を考慮すると任意とすべきだが、MVP-1では必須とする

**理由**:
1. **ターゲット企業**（日本の中堅製造業、50-500名）では必須が妥当
2. **検索・ソート機能に必須**
   - カナ名がないと「やまだ」で「山田」を検索できない
   - 五十音順ソートに必須
3. **MVP-1のスコープ外として国際化は将来対応**

**外国人社員の扱い**:
- ローマ字表記で代用する運用とする（例: "TANAKA TARO"）

**将来拡張**:
- MVP-2で国際化対応時に任意化を検討

### 3.5 監査列の設計

**目的**:
- 「誰が」社員マスタを登録/更新したか追跡（説明責任・Accountability）
- 内部統制報告制度（J-SOX）対応
- 不正なマスタ変更の検出・追跡

**実装方針（MVP-1）**:
- `created_by_login_account_id` / `updated_by_login_account_id` を保持
- **Phase 1（MVP-1）**: FK制約なし（login_accounts未実装のため、UUID参照のみ）
- **Phase 2（将来）**: login_accounts実装後にFK制約を追加

**アプリケーション層での保証**:
- Service層で userId を監査列に必ず設定
- NULL を許容するがバリデーションで実質的に必須化

### 3.6 楽観ロック（version）の採用

**背景**: マスタ系の同時実行制御

**方針**:
- **マスタ系**: 楽観ロック（version フィールド）
- **トランザクション系**: 悲観ロック（FOR UPDATE）

**理由**:
1. マスタ更新は低頻度だが、複数ユーザーが同時編集する可能性あり
2. 楽観ロックは性能オーバーヘッドがほぼゼロ（INTカラム1つ、WHERE条件1つ）
3. 実装の統一性・保守性が向上
4. 将来的に「マスタの変更履歴」機能を追加する際の基盤になる

**実装**:
- `version` フィールド（int, NOT NULL, DEFAULT 1）
- 更新時に version の一致をチェック
- 不一致の場合は `CONCURRENT_UPDATE` エラー

### 3.7 インデックス設計

**目的**: 検索・一覧取得・フィルタリング・ソートの高速化

**定義**:
- `INDEX(tenant_id, employee_code)` - 検索・一覧取得の高速化
- `INDEX(tenant_id, is_active)` - 有効社員のフィルタリング高速化
- `INDEX(tenant_id, join_date)` - 入社日範囲検索・ソートの高速化

**join_date インデックスの必要性**:
- 「2020年入社の社員一覧」等の範囲検索に対応
- 入社日でのソートに対応
- 一般的な業務要件として保持

---

## 4. employee_assignments（社員所属履歴）仕様概要

### 4.1 目的

- 社員の所属部門・主務/兼務・役割を**期間で管理**
- 組織改編に耐えるため **department_stable_id** を参照

### 4.2 主要概念

- **主務（primary）**: 1社員につき1部門（期間重複禁止推奨）
- **兼務（secondary）**: 複数部門への所属が可能
- **allocation_ratio**: 工数配分（任意）
- **role_in_department**: 部門内での役割（例: "部門長"）- 承認責務に利用

### 4.3 承認ルート判定

- 承認ルート判定は本テーブルを基点に行う
- employee_assignments → departments（stable_id経由）→ approval_routes

---

## 5. organization_versions（組織バージョン）仕様概要

### 5.1 目的

- 組織構造の**スナップショット管理**
- 申請・承認時点の組織を再現可能にする

### 5.2 主要概念

- **version_code**: 組織版の識別コード（例: "2025-04"）
- **effective_date** / **expiry_date**: 有効期間
- 申請時点で有効な version を固定してワークフローを確定する

---

## 6. departments（部門）仕様概要

### 6.1 目的

- 組織版内の部門実体を管理
- **stable_id** により版を跨いだ追跡が可能

### 6.2 主要概念

- **stable_id**: 版非依存ID（組織改編を跨いで同一部門を追跡）
- **version_id**: 所属する組織版（FK → organization_versions）
- **parent_id**: 階層構造（同一version内のみ）
- **manager_employee_id**: 部門責任者（参照用・表示用）

### 6.3 承認責任者の決定

- **manager_employee_id は「部門の代表責任者（参照用・表示用）」**
- **承認者の決定はWFルート（approval_route_steps / Seat）を正とする**
- manager固定運用はしない（柔軟な承認フロー設計のため）

---

## 7. login_accounts（ログインアカウント）仕様概要

### 7.1 目的

- ログイン・認証・セキュリティ専用エンティティ
- 社員（employees）との分離により、認証方式の拡張が容易

### 7.2 主要概念

- **employee_id**: 社員との1:1関係（UNIQUE(tenant_id, employee_id)）
- **auth_provider**: 認証方式（local/oidc/saml）
- **status**: アカウント状態（active/locked/disabled）

---

## 8. roles / login_account_roles 仕様概要

### 8.1 目的

- **RBAC（ロールベース）**による権限管理
- 1アカウントに複数ロールを付与可能

### 8.2 権限形式

- `procure.<domain>.<action>` 形式
- 例: `procure.employee-master.read`, `procure.employee-master.create`

---

## 9. 横断的な設計原則（全エンティティ共通）

### 9.1 マルチテナント分離（RLS）

**tenant_id 必須**:
- 全テーブルに tenant_id カラムを持つ
- すべてのクエリのWHERE句に tenant_id を明示（アプリケーション層ガード）
- RLSポリシーによる二重ガード

**RLS Policy 標準化**:
```sql
-- 全テーブルで統一
ALTER TABLE {table_name} ENABLE ROW LEVEL SECURITY;

CREATE POLICY "tenant_isolation" ON {table_name}
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::text);
```

**アプリケーション層**:
- 接続時に `SET app.current_tenant_id = '{tenant_id}';` を実行

### 9.2 論理削除

- **物理削除は禁止**
- `is_active=false` による論理無効化
- 監査証跡・説明責任のため履歴を必ず保持

### 9.3 楽観ロック（version）の標準化

- **全マスタエンティティ**は version フィールド（int, NOT NULL, DEFAULT 1）を持つ
- 更新時は version の一致をチェック、不一致の場合は CONCURRENT_UPDATE エラー
- **トランザクション系エンティティ**は悲観ロック（FOR UPDATE）を使用

### 9.4 監査列の標準化

- **全エンティティ**は created_by_login_account_id / updated_by_login_account_id を持つ
- login_accounts 実装後にFK制約を追加（MVP-1ではUUID参照のみ）

---

## 10. 制約事項・運用方針

### 10.1 コード体系

- **employee_code**: varchar(30)、テナント内一意、原則変更禁止
- 業務コード再利用禁止（is_active=false後の再利用は移行時例外のみ）

### 10.2 型定義の方針

- **email**: TEXT型（PostgreSQLではvarchar(255)と性能差なし、将来の拡張性重視）
- **remarks**: TEXT型（備考欄は長さ制限なし）
- **employee_name / employee_name_kana**: varchar(100)（一般的な長さで十分）

### 10.3 組織改編後の再現性

- 組織改編後も過去申請・承認の再現が可能であること
- organization_versions + department_stable_id により実現

---

## 11. 将来拡張（MVP-2以降）

### 11.1 employee_name_kana の国際化

- MVP-2で employee_name_kana を任意化
- または employee_name_kana_roman 列を追加（カナorローマ字）
- 検索ロジックの改修（カナ名なしでも検索可能に）

### 11.2 未実装エンティティ

現在は employees のみ実装済み。以下は将来実装:
- employee_assignments（所属履歴）
- organization_versions（組織版）
- departments（部門）
- login_accounts（アカウント）
- roles / login_account_roles（権限）

**既存データとの整合性**:
- employee_assignments 実装時に既存社員への対応方針を決定
  - 既存社員に「仮の所属」を自動生成するか
  - 所属なし社員を許容するか（is_active=false等で制御）

### 11.3 マスタ変更履歴

- version フィールドを基盤として、マスタ変更履歴テーブルを追加可能
- audit_logs テーブルで監査ログとして記録（別エンティティ）

---

## 12. 他マスタへの横展開

本仕様で確立した以下の設計原則を、他マスタ（Party/Item/UoM等）へ横展開する:

✅ **標準マスタエンティティのテンプレート**:
- tenant_id（必須）
- {entity}_code（業務コード、varchar(30)推奨）
- {entity}_name（表示名）
- remarks（備考、任意）
- is_active（論理無効）
- version（楽観ロック）
- created_at / updated_at
- created_by_login_account_id / updated_by_login_account_id

✅ **RLS Policy 標準化**:
- 全テーブルでRLS有効化 + tenant_isolation ポリシー

✅ **インデックス設計の基本方針**:
- INDEX(tenant_id, {entity}_code) - 検索・一覧取得
- INDEX(tenant_id, is_active) - フィルタリング
- その他、業務要件に応じて追加

---

以上。
