# 伝票種類・採番 仕様概要

# 1. スコープ
本ドキュメントは ProcureERP（購買管理SaaS）における以下を定義する。

- 伝票種類マスタ（DocumentType）
- 採番（Numbering Rule & Counter）
  - tenant別の採番ルールマスタ
  - tenant別の採番カウンタ（遅延作成）
  - 伝票番号（document_no）の生成規則

# 2. 前提（確定）
- マルチテナント：1テナント = 1自社法人
- RLS境界：tenant_id
- 物理削除は禁止、is_active=false による論理無効化
- 正本PK：UUID（例外なく各エンティティにUUIDのPKを持つ）
- 業務コード：人間可読用途（表示・検索・帳票・CSV・外部連携）
- 伝票種類はシステム固定（追加不可）：PR / RFQ / PO / GR / IR
- DocumentType は全テナント共通（グローバル参照）
- DocumentType はプロセス遷移（次伝票/自動生成）等の意味は持たない（MVPはアプリ固定ロジック）
- 採番は tenant別に設定可能（prefix等をテナントで変更可能）

# 3. 伝票種類（DocumentType）設計方針（確定）
- DocumentType は固定5種（PR/RFQ/PO/GR/IR）をシードし、tenantによる追加・削除は不可
- 参照は document_type_key（固定コード）を正とする（ただしPKはUUIDを持つ）
- WF対象フラグは DocumentType に保持し、以下で固定
  - PR：wf_enabled = true
  - RFQ：wf_enabled = false
  - PO：wf_enabled = true
  - GR：wf_enabled = false
  - IR：wf_enabled = true

# 4. 採番（Numbering Rule & Counter）設計方針（確定）
## 4.1 目的
伝票種別ごとに、各テナントが最小の設定で伝票番号（document_no）の見た目を制御できるようにする。

## 4.2 テナントが設定できるのは「3点のみ」（確定）
- prefix（先頭1桁の固定アルファベット：変更可能）
- 部門記号を番号に含めるか（include_department_symbol）
- 年月（期間）を番号に含めるか（period_kind：なし／年／年月）

※SEQはMVP固定（8桁ゼロ埋め、通し番号、リセットなし）

## 4.3 連番の分割（系列）単位（確定）
- sequence_scope_kind により系列分割を定義する。
  - COMPANY：全社連番（部門に依存しない）
  - DEPARTMENT：部門別連番（department_stable_id 単位）

※「全社連番」を「部門なし（NULL）」では表現しない。
COMPANYスコープは固定の scope_id（予約UUID）で表現する。

## 4.4 遅延作成（初回採番時にカウンタを作る：確定）
- document_number_counters は初回採番時に INSERT→ON CONFLICT で遅延作成する
- 同一系列に対する同時採番は、同一行更新の競合として待ち（正常動作）
- 欠番は許容（ERP標準）

## 4.5 伝票番号（document_no）生成規則（確定）
### 生成順（区切りなし：確定）
1. prefix（英大文字1桁）
2. department_symbol（include_department_symbol=true の場合のみ）
3. 期間文字列（period_kind=YY または YYMM の場合のみ）
4. SEQ（8桁ゼロ埋め）

※区切り文字は使用しない（結合のみ）

### 期間文字列の基準日（確定）
- period_kind が YY / YYMM の場合、期間文字列は伝票日 document_date（業務日付）を正とする

### document_no の不変性（確定）
- document_no は発番時に生成して凍結し、以後更新しない

## 4.6 部門記号（departments.department_symbol）前提（再掲：確定）
- department_symbol は番号表示用途のため、文字種制限を持つ
  - 英大文字・数字・`-`・`_` のみ
  - tenant内一意：UNIQUE(tenant_id, department_symbol)

# 5. 推奨の初期設定（Seed方針）
- tenant初期セット時に document_numbering_rules を以下の推奨値で作成する（運用開始を容易にする）
  - PR：prefix='R'、include_dept=false、period_kind=YYMM、scope=COMPANY、padding=8
  - RFQ：prefix='Q'、include_dept=false、period_kind=YYMM、scope=COMPANY、padding=8
  - PO：prefix='P'、include_dept=true、period_kind=YYMM、scope=DEPARTMENT、padding=8
  - GR：prefix='G'、include_dept=false、period_kind=YYMM、scope=COMPANY、padding=8
  - IR：prefix='I'、include_dept=true、period_kind=YYMM、scope=DEPARTMENT、padding=8

※GRは固定種別として存在するが、MVPでの利用可否はトランザクション仕様側で制御する（DocumentType自体は固定のまま）。

以上。
