# エンティティ定義：取引先系マスタ（Party / SupplierSite / Payee / CustomerSite / ShipTo）

本ドキュメントは、取引先系マスタのエンティティ定義である。  
仕様は別紙「取引先系マスタ 仕様概要」に従う。

---

## 1. parties（取引先法人 / Party）

### 仕様の概要
- 相手方の法人そのもの（会社単位で1レコード）
- 法人番号・インボイス番号等を保持する
- SupplierSite / CustomerSite の親エンティティ
- 導線用に is_supplier / is_customer を保持する（存在判定・検索・ナビ用）
- party_code は5桁固定（英数字可）とし、手入力／自動採番／移行投入のいずれも許容するが、tenant内一意制約を必須とする
- party_code の変更は原則禁止（移行時例外のみ）とし、必要な場合は派生表示コード（supplier_code等）も同時更新する

### エンティティ定義

| カラム                         | 型            | NULL | 例                     | 補足              |
| --------------------------- | ------------ | ---: | --------------------- | --------------- |
| id                          | uuid         |   NO | PTY-.                 | PK              |
| tenant_id                   | uuid         |   NO | TEN-.                 | RLS境界           |
| party_code                  | varchar(40)  |   NO | `P0001`               | **5桁運用**（採番は運用） |
| party_name                  | varchar(200) |   NO | `株式会社ABC`             | 正式名称            |
| party_name_kana             | varchar(200) |  YES | `カブシキガイシャエービーシー`      | 任意              |
| party_short_name            | varchar(200) |  YES | `ABC`                 | 略称              |
| country_code                | varchar(2)   |  YES | `JP`                  | ISO             |
| postal_code                 | varchar(20)  |  YES | `100-0001`            | ハイフン可           |
| prefecture                  | varchar(50)  |  YES | `東京都`                 |                 |
| city                        | varchar(100) |  YES | `千代田区`                |                 |
| address_line1               | varchar(200) |  YES | `丸の内1-1-1`            |                 |
| address_line2               | varchar(200) |  YES | `○○ビル10F`             |                 |
| phone                       | varchar(40)  |  YES | `03-xxxx-xxxx`        | 代表電話            |
| fax                         | varchar(40)  |  YES | `03-xxxx-xxxx`        | 任意              |
| website_url                 | text         |  YES | `https://example.com` | 任意              |
| corporate_number            | varchar(20)  |  YES | `1234567890123`       | 法人番号（日本）        |
| invoice_registration_no     | varchar(30)  |  YES | `T1234567890123`      | インボイス登録番号       |
| is_supplier                 | boolean      |   NO | true                  | 仕入先系を持つか（導線/検索用の派生フラグ。supplier_sites存在でtrueに更新） |
| is_customer                 | boolean      |   NO | false                 | 得意先系を持つか（導線/検索用の派生フラグ。customer_sites存在でtrueに更新／将来拡張）    |
| is_active                   | boolean      |   NO | true                  | 無効は選択不可         |
| notes                       | text         |  YES |                       | メモ              |
| created_at                  | timestamptz  |   NO |                       |                 |
| updated_at                  | timestamptz  |   NO |                       |                 |
| created_by_login_account_id | uuid         |  YES | ACC-.                 | 監査（任意）          |
| updated_by_login_account_id | uuid         |  YES | ACC-.                 | 監査（任意）          |

### 制約条件
- UNIQUE(tenant_id, party_code)
- is_active=false は新規選択不可 

### 補足事項
- Partyは「法人」の正本であり、拠点・部門・支払はSite側で表現する
- 住所・連絡先はPartyにも持つが、実務窓口はSupplierSite/CustomerSiteの値を優先する（画面仕様で明確化）

---

## 2. supplier_sites（仕入先拠点 / SupplierSite）

### 仕様の概要
- 取引先（Party）に紐づく「購買の実務窓口」拠点
- 発注・見積・納期回答の相手（購買の主役エンティティ）
- 支払先（Payee）を参照する（未指定なら自動生成）
- 住所・連絡先は**1セットのみ**（MVP最適・推奨）

### エンティティ定義

| カラム | 型 | NULL | 例 | 補足 |
|---|---|---:|---|---|
| id | uuid | NO | SUPSITE-. | PK |
| tenant_id | uuid | NO | TEN-. | RLS境界 |
| party_id | uuid | NO | PTY-. | FK parties |
| supplier_sub_code | varchar(40) | NO | `00001` / `0A0B1` | **5桁固定**（テナント設定）※保存時正規化 |
| supplier_code | varchar(100) | NO | `P0001-00001` | 表示用（保持） |
| supplier_name | varchar(200) | NO | `株式会社ABC 東京営業所` | 拠点名 |
| supplier_name_kana | varchar(200) | YES |  | 任意 |
| postal_code | varchar(20) | YES |  | 購買窓口住所（1セット） |
| prefecture | varchar(50) | YES |  | |
| city | varchar(100) | YES |  | |
| address_line1 | varchar(200) | YES |  | |
| address_line2 | varchar(200) | YES |  | |
| phone | varchar(40) | YES |  | 連絡先（1セット） |
| fax | varchar(40) | YES |  | 任意 |
| email | varchar(254) | YES |  | 任意 |
| contact_name | varchar(100) | YES |  | 任意 |
| payee_id | uuid | YES | PAY-. | FK payees（未指定なら自動生成） |
| is_active | boolean | NO | true | 無効は選択不可 |
| notes | text | YES |  | |
| created_at | timestamptz | NO |  | |
| updated_at | timestamptz | NO |  | |
| created_by_login_account_id | uuid | YES | ACC-. | 監査（任意） |
| updated_by_login_account_id | uuid | YES | ACC-. | 監査（任意） |

### 制約条件
- UNIQUE(tenant_id, party_id, supplier_sub_code)
- UNIQUE(tenant_id, supplier_code)
- FK(tenant_id, party_id) -> parties(tenant_id, id)
- FK(tenant_id, payee_id) -> payees(tenant_id, id) 

### 補足事項
- `payee_id`未指定時：Payeeを自動生成して紐づけ（仕様MD 5章）
- 自動生成Payeeのsub_codeは `supplier_sub_code` と同一（仕様MD 5.2）
- 初回コピーのみ・以後独立（同期なし）（仕様MD 5.3） 

---

## 3. payees（支払先 / Payee）

### 仕様の概要
- 支払・請求書受領・振込の単位（AP/支払の正本）
- 一括請求（複数仕入先→1支払先）を将来扱うため、SupplierSiteと分離
- 支払条件はV1では「決済方法＋金種＋テキスト」で保持（payment_termsの別テーブル化はV2以降）

### エンティティ定義

| カラム | 型 | NULL | 例 | 補足 |
|---|---|---:|---|---|
| id | uuid | NO | PAY-. | PK |
| tenant_id | uuid | NO | TEN-. | RLS境界 |
| party_id | uuid | NO | PTY-. | FK parties |
| payee_sub_code | varchar(40) | NO | `00001` / `0A0B1` | **5桁固定**（テナント設定）※保存時正規化 |
| payee_code | varchar(100) | NO | `P0001-00001` | 表示用（保持） |
| payee_name | varchar(200) | NO | `株式会社ABC 本社（支払）` | 支払先名称（正本） |
| payee_name_kana | varchar(200) | YES |  | 任意 |
| payee_postal_code | varchar(20) | YES |  | 支払先住所 |
| payee_prefecture | varchar(50) | YES |  | |
| payee_city | varchar(100) | YES |  | |
| payee_address_line1 | varchar(200) | YES |  | |
| payee_address_line2 | varchar(200) | YES |  | |
| payee_phone | varchar(40) | YES |  | |
| payee_fax | varchar(40) | YES |  | |
| payee_email | varchar(254) | YES |  | |
| payee_contact_name | varchar(100) | YES |  | |
| payment_method | varchar(20) | YES | `bank_transfer` | 決済方法（V1） |
| currency_code | varchar(3) | YES | `JPY` | 金種（V1） |
| payment_terms_text | text | YES | `月末締め翌月末払` | 決済条件（V1） |
| default_payment_term_id | uuid | YES | PT-. | V2以降（payment_terms） |
| is_active | boolean | NO | true | |
| notes | text | YES |  | |
| created_at | timestamptz | NO |  | |
| updated_at | timestamptz | NO |  | |
| created_by_login_account_id | uuid | YES | ACC-. | |
| updated_by_login_account_id | uuid | YES | ACC-. | |

### 制約条件
- UNIQUE(tenant_id, party_id, payee_sub_code)
- UNIQUE(tenant_id, payee_code)
- FK(tenant_id, party_id) -> parties(tenant_id, id) 

### 補足事項
- 既存Payee選択候補は **同一 party_id のみ**（MVP安全策：仕様MD 4.2） 
- `payment_method` / `currency_code` / `payment_terms_text` は **V1での最小保持**（仕様MD 6章）

---

## 4. customer_sites（得意先拠点 / CustomerSite）【凍結】

### 仕様の概要
- 取引先（Party）に紐づく「販売の実務窓口」拠点
- SupplierSiteの“裏返し”構造（同等の粒度・住所連絡先1セット）
- 将来の卸・商社・受発注統合を見据え、先行して骨格を凍結する

### エンティティ定義

| カラム | 型 | NULL | 例 | 補足 |
|---|---|---:|---|---|
| id | uuid | NO | CUSSITE-. | PK |
| tenant_id | uuid | NO | TEN-. | RLS境界 |
| party_id | uuid | NO | PTY-. | FK parties（得意先法人） |
| customer_sub_code | varchar(40) | NO | `00001` / `0A0B1` | **5桁固定**（テナント設定）※保存時正規化 |
| customer_code | varchar(100) | NO | `P0001-00001` | 表示用（`party_code` + `-` + `customer_sub_code` を自動生成して保持） |
| customer_name | varchar(200) | NO | `株式会社DEF 大阪支店` | 得意先拠点名（party_nameとは別で保持可） |
| customer_name_kana | varchar(200) | YES |  | 任意 |
| postal_code | varchar(20) | YES | `530-0001` | 連絡先住所（販売窓口：1セット） |
| prefecture | varchar(50) | YES | `大阪府` |  |
| city | varchar(100) | YES | `大阪市北区` |  |
| address_line1 | varchar(200) | YES | `梅田1-1-1` |  |
| address_line2 | varchar(200) | YES | `○○ビル10F` |  |
| phone | varchar(40) | YES | `06-xxxx-xxxx` | 連絡先（1セット） |
| fax | varchar(40) | YES |  | 任意 |
| email | varchar(254) | YES |  | 任意 |
| contact_name | varchar(100) | YES |  | 任意 |
| is_active | boolean | NO | true | 無効は選択不可（論理無効） |
| notes | text | YES |  | メモ |
| created_at | timestamptz | NO |  |  |
| updated_at | timestamptz | NO |  |  |
| created_by_login_account_id | uuid | YES | ACC-. | 監査（任意） |
| updated_by_login_account_id | uuid | YES | ACC-. | 監査（任意） |

### 制約条件
- UNIQUE(tenant_id, party_id, customer_sub_code)
- UNIQUE(tenant_id, customer_code)
- FK(tenant_id, party_id) -> parties(tenant_id, id) 

### 補足事項
- CustomerSiteは将来の販売領域拡張の“受け皿”だが、MVPでは購買側の直送・請求照会などで先に参照される可能性があるため、粒度をSupplierSiteと揃える
- 住所・連絡先は1セットのみ（MVP最適）

---

## 5. ship_tos（納入先 / ShipTo）

### 仕様の概要
- 得意先（CustomerSite）が指定する「実際にモノを届ける場所」
- エンドユーザー／現場／工事場所等の直送先を含む
- ShipTo は CustomerSite 配下（customer_site_id で参照）
- ただし、納入先コード（ship_to_code）は独立した別コードとして管理し、
  親子関係がコード上・対外上に見える形式は採用しない
- 住所・連絡先は1セットのみ（MVP）

### エンティティ定義

| カラム | 型 | NULL | 例 | 補足 |
|---|---|---:|---|---|
| id | uuid | NO | SHIP-... | PK |
| tenant_id | uuid | NO | TEN-... | RLS境界 |
| customer_site_id | uuid | NO | CUSSITE-... | FK customer_sites |
| ship_to_code | varchar(40) | NO | `00001` / `0A0B1` | **5桁固定**（テナント設定）※保存時正規化／独立コード |
| ship_to_name | varchar(200) | NO | `DEF工場 第1倉庫` | 納入先名称 |
| ship_to_name_kana | varchar(200) | YES |  | 任意 |
| postal_code | varchar(20) | YES | `123-4567` | 納入先住所（1セット） |
| prefecture | varchar(50) | YES |  |  |
| city | varchar(100) | YES |  |  |
| address_line1 | varchar(200) | YES |  |  |
| address_line2 | varchar(200) | YES |  |  |
| phone | varchar(40) | YES |  | 連絡先（1セット） |
| fax | varchar(40) | YES |  | 任意 |
| email | varchar(254) | YES |  | 任意 |
| contact_name | varchar(100) | YES |  | 任意 |
| is_active | boolean | NO | true | 無効は選択不可（論理無効） |
| notes | text | YES |  | メモ |
| created_at | timestamptz | NO |  |  |
| updated_at | timestamptz | NO |  |  |
| created_by_login_account_id | uuid | YES | ACC-... | 監査（任意） |
| updated_by_login_account_id | uuid | YES | ACC-... | 監査（任意） |

### 制約条件
- UNIQUE(tenant_id, ship_to_code)
- FK(tenant_id, customer_site_id) -> customer_sites(tenant_id, id)

### 補足事項
- 自社倉庫・自社拠点は倉庫マスタで管理し、ShipToは直送先中心
- 得意先→納入先の関係は customer_site_id で担保し、外部に見せない

---

## 6. コード正規化（共通）

保存時に以下を適用する：
- trim（前後空白除去）
- 半角化
- 英字は大文字に統一（英数字モード時）

文字種制約はテナント設定に従う：
- 数字のみ：`^[0-9]{5}$`
- 英数字：`^[0-9A-Z]{5}$`
- 論理無効化（is_active=false）後のコード再利用は禁止（復活は同一レコードを再活性化で対応） 
