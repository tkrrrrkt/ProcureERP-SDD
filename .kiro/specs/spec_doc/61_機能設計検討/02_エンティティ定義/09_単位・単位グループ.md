# 単位（UoM）・単位グループ（UoMGroup） エンティティ定義

# 0. 共通
- 物理削除禁止：is_active=false により論理無効化
- 監査カラム：created_at / created_by_login_account_id / updated_at / updated_by_login_account_id
- UUID：全エンティティでPK（id）として保持
- RLS境界：tenant_id
- 論理無効化（is_active=false）後のコード再利用は禁止（復活は同一レコードを再活性化で対応）

---

# 1. uom_groups（単位グループ / UoMGroup）
## 1.1 仕様概要
- 単位の「互換枠」を定義する（同一枠内のみ将来換算可能）
- UoMGroup は tenant別に保持する（企業ごとの単位体系差異を許容）
- UoMGroup は少数（標準）を想定（COUNT/WEIGHT等）
- 各UoMGroupは基準単位（base_uom）を必須とする（標準ERP寄り）
- uom_group_code は業務コードであり、原則変更禁止（移行例外のみ）

## 1.2 エンティティ定義
### uom_groups
|列名|型|NULL|例|説明|
|---|---|---:|---|---|
|id|uuid|NO|UUID|正本PK|
|tenant_id|uuid|NO|TEN-...|RLS境界|
|uom_group_code|text|NO|`COUNT`|業務コード（原則変更禁止）|
|uom_group_name|text|NO|`個数`|表示名（変更可）|
|description|text|YES|`個数系の互換枠`|説明|
|base_uom_id|uuid|NO|UUID|基準単位（uoms.id）|
|is_active|boolean|NO|true|論理有効|
|created_at|timestamptz|NO||作成日時|
|created_by_login_account_id|uuid|NO||作成者|
|updated_at|timestamptz|NO||更新日時|
|updated_by_login_account_id|uuid|NO||更新者|

## 1.3 制約条件
- PRIMARY KEY (id)
- UNIQUE (tenant_id, uom_group_code)
- CHECK (uom_group_code ~ '^[A-Z0-9_-]{1,10}$')  ※英数字大文字＋-/_のみ、1〜10文字
- FOREIGN KEY (base_uom_id) REFERENCES uoms(id)

## 1.4 補足事項
- base_uom_id を必須とするため、uom_groups と uoms は相互参照となる
  - uom_groups.base_uom_id → uoms.id
  - uoms.uom_group_id → uom_groups.id
- 作成時は「同一トランザクション内でUUIDを先に確定」し、両方をINSERTして整合させる
  - PostgreSQLではFKを DEFERRABLE（遅延検証）とする運用を推奨（コミット時整合）
- uom_group_code は原則変更禁止（移行時の誤登録訂正などの例外のみ）

---

# 2. uoms（単位 / UoM）
## 2.1 仕様概要
- 数量の単位を定義する（品目・伝票明細で使用）
- UoM は tenant別に保持する（企業固有の単位を許容）
- uom_code は連携・表記揺れ防止のため厳格化する
  - 英数字大文字＋`-`/`_`のみ、1〜10文字
- 表示名（uom_name）は日本語を許容する
- uom_code は原則変更禁止（移行例外のみ）

## 2.2 エンティティ定義
### uoms
|列名|型|NULL|例|説明|
|---|---|---:|---|---|
|id|uuid|NO|UUID|正本PK|
|tenant_id|uuid|NO|TEN-...|RLS境界|
|uom_group_id|uuid|NO|UUID|所属グループ（uom_groups.id）|
|uom_code|text|NO|`PCS`|業務コード（原則変更禁止）|
|uom_name|text|NO|`個`|表示名（変更可）|
|uom_symbol|text|YES|`個`|記号（帳票/画面用、任意）|
|is_active|boolean|NO|true|論理有効|
|created_at|timestamptz|NO||作成日時|
|created_by_login_account_id|uuid|NO||作成者|
|updated_at|timestamptz|NO||更新日時|
|updated_by_login_account_id|uuid|NO||更新者|

## 2.3 制約条件
- PRIMARY KEY (id)
- UNIQUE (tenant_id, uom_code)
- CHECK (uom_code ~ '^[A-Z0-9_-]{1,10}$')  ※英数字大文字＋-/_のみ、1〜10文字
- FOREIGN KEY (uom_group_id) REFERENCES uom_groups(id)

## 2.4 補足事項
- uom_code は原則変更禁止（移行時の誤登録訂正などの例外のみ）
- base_uom は uom_groups.base_uom_id が指す単位を正とする（uoms側に is_base は持たない）

---

# 3. 関連（既存エンティティへの追記方針）
※本節は「単位マスタ設計」としての整合方針であり、既存MDの該当エンティティ定義（品目・伝票）へ追記する。

## 3.1 品目（Item）への単位付与（確定）
- items.base_uom_id（必須）：品目の正の単位（集計・将来拡張の芯）
- items.purchase_uom_id（任意）：購買入力のデフォルト単位
  - 未設定時は base_uom を購買単位とみなす
- base_uom と purchase_uom が同一UoMGroup所属であることは **アプリ層**で担保する（MVP軽量）

## 3.2 伝票明細の単位制限（確定：MVP事故防止）
- 伝票明細の uom_id は「品目の base_uom_id / purchase_uom_id のいずれか」のみ許可する
- デフォルトは purchase_uom（未設定ならbase）
- 将来（単位換算ON）に同一UoMGroup内の任意単位へ拡張可能

---

# 4. 将来拡張（V2以降：参考）
- uom_conversions（同一UoMGroup内の固定換算：kg↔g 等）
- item_uom_conversions（品目別換算：荷姿の中核。1箱=12個 等）
- 外部標準コードやマッピング（取引先/EDI向け）
※V2で別ドキュメントとして定義する

以上。
