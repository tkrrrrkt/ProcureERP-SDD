# ProcureERP — Production Ready 判定チェックリスト（RAG付き）
（目的：エンティティ定義を"本番水準で安定化"させるための、設計〜実装〜運用の品質ゲート）

- 対象：ProcureERP 全エンティティ（9領域：社員・組織/WF/取引先/共通・銀行・倉庫/消費税/品目/カテゴリ/伝票種類・採番/単位）
- 境界：マルチテナント（tenant_id）・RLS・論理削除（is_active=false）・UUID正本PK を前提
- 使い方：
  1) まず「GATE判定表」を埋める（全体のReady度合い）
  2) 次に「横断チェック（全テーブル共通）」を実施（棚卸し）
  3) 最後に「領域別（ドメイン別）チェック」を実施（穴を塞ぐ）
  4) R/A が残る項目は "修正チケット化" し、Spec Freeze vNext に反映する
  5) 各エンティティMD末尾に「セルフチェック表（5. Appendix）」を貼付して個別管理

---

## 0. RAG定義（運用ルール）
### RAG基準
- **Green（G）**：受け入れ基準を満たす／証跡がある／運用・実装で迷いがない
- **Amber（A）**：致命ではないが、運用や拡張で事故り得る（回避策/チケットが必要）
- **Red（R）**：本番投入不可（データ隔離、整合性、セキュリティ、監査、復旧に重大な欠陥）

### 判定ルール（Stop/Go）
- **Production Ready**：R=0 かつ Aが「許容範囲」内（下記）  
- **Implementation Ready**：R=0 かつ Aが残っても “回避策が仕様に明記され、実装が迷わない”  
- **Design Ready**：大枠合意済。A/Rが残るが、修正方針が確定している

### Amber許容（目安）
- 全体：A ≤ 10（かつ、Security/Isolation/RecoveryにAが無いことが望ましい）
- ただし **Isolation（RLS）/Recovery（バックアップ復旧）/Data Integrity（重大制約）** は Aでも本番前に潰す（=実質R扱い）

---

## 1. GATE判定表（最初に埋める）
| Gate | 目的 | 条件（最低限） | 判定（R/A/G） | 根拠（証跡リンク/メモ） |
|---|---|---|---|---|
| G1: Design Ready | 仕様として矛盾なく合意 | 用語/責務/スコープが確定、依存関係が明文化 |  |  |
| G2: Implementation Ready | 実装に迷いがない | DDL方針、RLS方針、制約/インデックス方針、API粒度の前提が揃う |  |  |
| G3: Release Ready（MVP） | MVPリリース可能 | 最低限の運用（初期設定/移行/監査/障害時復旧）が成立 |  |  |
| G4: Production Ready | 本番運用に耐える | セキュリティ/隔離/復旧/監視/性能の“運用手順”まで揃う |  |  |

---

## 2. 横断チェック（全エンティティ共通）
> ここが“エンティティ定義の安定化”に最も効く。全テーブル棚卸しでRを0にする。

### 2.1 共通属性・ライフサイクル（必須）
| ID | チェック | 受け入れ基準（合格条件） | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| X-001 | tenant_idの有無 | テナント別テーブルは **tenant_id必須**（参照専用を除く） | 全テーブル一覧 |  |  |
| X-002 | RLS適用 | 全テナント別テーブルに **RLSポリシー（CRUD別）**が定義済 | RLS一覧/DDL |  |  |
| X-003 | UUID正本PK | 全テーブルで id(UUID)が正本PK（例外は明記） | DDL/定義 |  |  |
| X-004 | 論理削除 | 物理削除なし：is_active=false運用が仕様・実装に明記 | 仕様/DDL |  |  |
| X-005 | 監査カラム | created_at/updated_at + created_by_login_account_id/updated_by_login_account_id の方針が統一 | 仕様/DDL |  |  |
| X-006 | タイムゾーン | timestampの型（timestamptz等）と基準（UTC等）を統一 | DDL方針 |  |  |

### 2.2 コード体系（運用事故の温床）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| X-101 | 業務コード一意 | 5桁コードの一意範囲（tenant内/会社内）を明記し制約がある | 仕様/DDL |  |  |
| X-102 | コード再利用方針 | is_active=false後の **コード再利用可否**が明文化（UNIQUE設計と整合） | 仕様 |  |  |
| X-103 | 表示コード | “表示用（結合）コード”と“保存コード”が混同されていない | 画面/CSV仕様 |  |  |
| X-104 | 変更可否 | party_code 等 “原則変更禁止”の扱い（例外条件）明記 | 仕様 |  |  |

### 2.3 制約・参照整合（DBで守る/アプリで守るの線引き）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| X-201 | FK整合 | FKで守れるものはFKで守る（例外は“理由+担保策”） | ERD/DDL |  |  |
| X-202 | UNIQUE整合 | UNIQUEが仕様上成立（履歴/論理削除/NULL）し、矛盾がない | 仕様/DDL |  |  |
| X-203 | NULL×UNIQUE | NULL運用がある場合、重複防止策が明記（partial unique等） | 仕様/DDL |  |  |
| X-204 | CHECK整合 | 日付範囲や数値範囲のCHECKが仕様と一致 | 仕様/DDL |  |  |
| X-205 | 多対多の重複 | 中間テーブルに (tenant_id, a_id, b_id) 等の重複防止がある | DDL |  |  |

### 2.4 性能・索引（最低限）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| X-301 | 主要検索索引 | code検索、一覧、WF一覧等のクエリにインデックス方針あり | index一覧 |  |  |
| X-302 | tenant_id索引 | RLS境界により tenant_id を含む索引が設計されている | index一覧 |  |  |
| X-303 | 監査/履歴索引 | version_id/stable_id 等の参照に索引がある | index一覧 |  |  |

### 2.5 運用（本番で必須）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| X-401 | バックアップ/復旧 | 復旧手順（RTO/RPO）と検証結果がある | runbook |  |  |
| X-402 | 移行/初期設定 | 初期データ投入の順序と失敗時の巻戻しが定義済 | 手順書 |  |  |
| X-403 | 監視/アラート | DB/アプリの最低監視項目（遅延・失敗・エラー率）定義 | 監視設計 |  |  |
| X-404 | 監査ログ | 重要イベント（承認/マスタ変更）を追える設計 | 仕様 |  |  |
| X-405 | 権限/運用ロール | 管理者・移行者・閲覧者などの権限が定義済 | 権限表 |  |  |

### 2.6 SSoT/設計統制（仕様の一貫性）
> 仕様概要 ⇔ エンティティ定義 ⇔ DDL の"ズレ"を検出し、二重管理・矛盾を防ぐ

| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| X-501 | SSoT一致 | 同一領域に"別バージョン"の定義が混在していない（命名・制約・キー） | 仕様比較 |  |  |
| X-502 | 仕様⇔DDL整合 | 仕様概要 ⇔ エンティティ定義 ⇔ DDL が一致している | DDL差分 |  |  |
| X-503 | 変更管理 | 仕様変更はADR/チケットで履歴化されている | ADR/チケット |  |  |
| X-504 | 命名統一 | 監査カラム（created_by_login_account_id等）が全テーブルで統一（例外は明記） | 仕様/DDL |  |  |
| X-505 | 例外値定義 | 「未設定」「不明」「廃止」などの例外値の扱いが定義されている | 仕様 |  |  |

---

## 3. 領域別チェック（9領域）
> 横断で合格しても、ドメイン固有の“事故点”が残る。ここで潰す。

---

### 3.1 社員・組織・部門・アカウント・権限
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| O-001 | stable_id+version_idの整合 | 履歴テーブルで UNIQUE/参照が version前提で揃う | DDL/仕様 |  |  |
| O-002 | 組織改編シナリオ | 改編（統廃合/名称変更/異動）でデータが壊れない説明がある | 業務シナリオ |  |  |
| O-003 | manager_employee_idの位置づけ | “参照用”でWF決定の正本ではないことが明記 | 仕様 |  |  |
| O-004 | 権限モデルの粒度 | ロール/権限の粒度と拡張方針が明記 | 権限表 |  |  |

---

### 3.2 汎用ワークフロー（WF）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| W-001 | 固定WF原則 | submit時に確定→以後不変（task固定）の一貫性 | 仕様 |  |  |
| W-002 | Seatの一意担保 | NULL運用時の重複防止（partial unique index or アプリ制約）が明文化 | 仕様/DDL |  |  |
| W-003 | 代理適用の基準日 | submitted_at等 “基準日” が一意に定義されている | 仕様 |  |  |
| W-004 | 金額条件×通貨 | currency_codeが正本、FXは将来拡張が明記 | 仕様 |  |  |
| W-005 | 監査・証跡 | 誰が承認/却下したかを追えるデータ設計 | 仕様/ERD |  |  |

---

### 3.3 取引先系（Party / SupplierSite / Payee / CustomerSite / ShipTo）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| P-001 | Party起点の責務 | 法人/拠点/支払が混ざっていない（役割分離） | 仕様/ERD |  |  |
| P-002 | party_code運用 | 手入力/自動/移行、変更禁止（例外条件）が明文化 | 仕様 |  |  |
| P-003 | is_supplier/is_customer | 派生フラグであること、更新契機が明記 | 仕様 |  |  |
| P-004 | 住所の分割 | 日本住所分割項目が一貫（郵便/都道府県/市区町村/番地/建物等） | 仕様 |  |  |
| P-005 | 将来拡張 | 一括請求/親子関係などの拡張が壊れない | 仕様 |  |  |

---

### 3.4 共通・銀行・倉庫
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| C-001 | Currencyのスコープ | 参照専用（全テナント共通）で整合している | 仕様 |  |  |
| C-002 | 銀行コード | 全銀協コード等、必須項目が明確 | 仕様 |  |  |
| C-003 | 口座のdefault | is_defaultの制約（同一Payee内で1件）担保が明記 | 仕様/DDL |  |  |
| C-004 | 倉庫境界 | 在庫V2を見据え、MVPで抱え込みすぎない | 仕様 |  |  |

---

### 3.5 消費税（TaxBusinessCategory / TaxRate / TaxCode）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| T-001 | Tax区分×税率分離 | 税制改定に耐える設計（Rate改定、経過措置） | 仕様 |  |  |
| T-002 | 伝票の正本キー | 明細でTaxCodeを保持する方針が明記 | 仕様 |  |  |
| T-003 | インボイス方針 | Party.invoice_registration_no 連携方針が明記 | 仕様 |  |  |
| T-004 | 将来拡張の境界 | 検証（国税庁照合等）をMVP対象外として明記 | 仕様 |  |  |

---

### 3.6 品目（Item / ItemVariant / ItemAttribute / ItemVariantAttribute）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| I-001 | Item-Variant責務分離 | SKU=取引/集計単位、Item=品目概念が一貫 | 仕様 |  |  |
| I-002 | ベースSKU | variant_code=00000 の予約・default_variant_id が明記 | 仕様 |  |  |
| I-003 | VARIANT_KEY/INSTANCE_KEY | 自由入力はINSTANCEのみ、在庫キー化はV2で検討が明確 | 仕様 |  |  |
| I-004 | tenant_id完全性 | 関連テーブル（特にItemVariantAttribute）に tenant_id がありRLS前提が崩れない | 仕様/DDL |  |  |
| I-005 | SKU組合せ一意 | “属性×値の組合せ重複”を防ぐ担保策（アプリ/DB）が明記 | 仕様 |  |  |

---

### 3.7 カテゴリ・セグメント（CategoryAxis / Segment / SegmentAssignment）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| S-001 | 1軸1値制約 | 同一 entity×axis に1値である制約が明記 | 仕様/DDL |  |  |
| S-002 | 階層制限 | ITEMのみ階層可、他は不可の境界が明確 | 仕様 |  |  |
| S-003 | polymorphic参照 | entity_idにFKが無い理由と担保策（アプリ検証・整合バッチ）が明記 | 仕様 |  |  |
| S-004 | 将来拡張 | トランザクション割当など拡張時の設計方針がある | 仕様 |  |  |

---

### 3.8 伝票種類・採番（DocumentType / NumberingRule / NumberCounter）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| D-001 | DocumentTypeのスコープ | グローバル参照（tenant_id無し）が明確、5種固定（PR/RFQ/PO/GR/IR） | 仕様/DDL |  |  |
| D-002 | wf_enabledの整合 | 伝票種別ごとのWF対象可否がDocumentTypeで一元管理 | 仕様 |  |  |
| D-003 | 採番ルール柔軟性 | prefix/department_symbol/period_kindの3点のみ設定可で過不足ない | 仕様 |  |  |
| D-004 | カウンタ遅延作成 | INSERT→ON CONFLICTで初回採番時に作成、競合解決が明記 | 仕様/DDL |  |  |
| D-005 | scope_id予約値 | COMPANYスコープの固定UUID（00000000-...）が明記、実データと衝突しない | 仕様 |  |  |
| D-006 | document_no不変性 | 発番時に凍結、以後更新しない方針が明記 | 仕様 |  |  |
| D-007 | 期間基準日 | period_kindの基準日がdocument_date（業務日付）と明記 | 仕様 |  |  |

---

### 3.9 単位・単位グループ（UoMGroup / UoM）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| U-001 | 循環参照対策 | uom_groups.base_uom_id ↔ uoms.uom_group_idの相互FKがDEFERRABLEで解決 | 仕様/DDL |  |  |
| U-002 | uom_code厳格化 | `^[A-Z0-9_-]{1,10}$` の制約が明記、表記揺れ防止 | 仕様/DDL |  |  |
| U-003 | base_uom必須 | 各UoMGroupにbase_uom_idが必須、同時INSERT方針が明記 | 仕様 |  |  |
| U-004 | 品目との紐づけ | items.base_uom_id（必須）/purchase_uom_id（任意）の方針が明記 | 仕様 |  |  |
| U-005 | 伝票明細制限 | MVP: base/purchaseのいずれかのみ許可、将来拡張（同一UoMGroup内）が明記 | 仕様 |  |  |
| U-006 | 互換性チェック | base_uom と purchase_uom の同一UoMGroup所属チェックがアプリ層担保と明記 | 仕様 |  |  |
| U-007 | コード変更禁止 | uom_group_code / uom_code は原則変更禁止（移行例外のみ）が明記 | 仕様 |  |  |

---

## 4. 証跡（Production Readyに必要な最小成果物）
> “レビューが高得点”でも、証跡が無いと本番判定できない。最低限ここまで揃える。

| 成果物 | 内容 | 必須Gate |
|---|---|---|
| ERD（論理/物理） | tenant_id/PK/FK/UNIQUE含む | G2/G3/G4 |
| DDL方針（PostgreSQL前提） | 型、timestamptz、partial unique index等 | G2/G4 |
| RLS一覧（CRUD別） | テーブルごとのポリシー（例：USING/WITH CHECK） | G3/G4 |
| Index一覧 | 主要検索×tenant_id×履歴参照 | G3/G4 |
| 移行/初期設定Runbook | 初期投入順、巻戻し、再実行 | G3 |
| バックアップ/復旧Runbook | RTO/RPO、テナント単位復旧可否 | G4 |
| 監査ログ方針 | 追跡対象イベント、保持期間 | G4 |

---
<!-- 追補：Production Ready 判定チェックリスト（RAG付き）に追加するセクション -->
<!-- 追加位置：4. 証跡（Production Readyに必要な最小成果物）の直後を推奨 -->

---

## 4A. 全テーブル棚卸し（横断：必須証跡テンプレ）
> 目的：tenant_id / is_active / 監査 / PK/FK/UNIQUE / Index の“抜け漏れ”を機械的に潰す  
> 運用：この表を埋めるだけで、横断チェック（X-001〜X-305）の大半が判定可能になる

### 4A-1. 棚卸し表（テーブル単位）
- 記入ルール：
  - **Scope**：`tenant`（テナント別） / `global`（全テナント共通参照） / `system`（内部・運用）
  - **RLS**：`Y/N`（tenantの場合は原則Y）
  - **SoftDelete**：`is_active`（Y/N）※tenantテーブルは原則Y
  - **AuditCols**：`created_at, updated_at, created_by_login_account_id, updated_by_login_account_id` の有無
  - **PK**：`id(UUID)` 等
  - **CodeCols**：5桁コード（例：party_code 等）と一意範囲
  - **FKs**：参照先（tenant_id整合含む）
  - **UNIQUEs**：NULL/履歴/論理削除との整合も記載
  - **Indexes**：主要検索＋tenant_idを含むか
  - **RAG**：横断観点の“総合”RAG（Rがあれば即チケット）

| Domain | Table | Scope | tenant_id | RLS | SoftDelete | AuditCols | PK | CodeCols（範囲/変更可否） | FKs（主要） | UNIQUEs（注意点含む） | Indexes（主要） | Notes（例外/担保策） | RAG |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| Org | employees | tenant | Y | Y | Y | Y | id(UUID) | employee_code（tenant内/原則変更禁止） | dept_id→departments | (tenant_id, employee_code) | (tenant_id, employee_code) |  |  |
| Org | departments | tenant | Y | Y | Y | Y | id(UUID) | department_code（tenant内/要方針） | version_id→org_versions | (tenant_id, version_id, stable_id) | (tenant_id, version_id, stable_id) | stable_id運用 |  |
| WF | department_approver_slots | tenant | Y | Y | Y | Y | id(UUID) | - | dept_stable_id→departments(stable) | 将来: (tenant, dept_stable, level, effective) / MVP: partial unique | (tenant_id, dept_stable_id, slot_level_no) | NULL運用注意 |  |
| Party | parties | tenant | Y | Y | Y | Y | id(UUID) | party_code（tenant内一意/原則変更禁止） | - | (tenant_id, party_code) | (tenant_id, party_code) | is_supplier派生 |  |
| Item | item_variant_attributes | tenant | Y | Y | Y | - | id(UUID) | - | variant_id→item_variants | 重複防止方針（I-005） | (tenant_id, variant_id, attribute_id) | 組合せ一意 |  |
| Segment | segment_assignments | tenant | Y | Y | Y | Y | id(UUID) | - | （polymorphic） | (tenant_id, entity_id, axis_id)等 | (tenant_id, axis_id, entity_id) | FK無し担保 |  |
| DocType | document_types | global | N | N | Y | Y | id(UUID) | document_type_key（グローバル一意/固定） | - | (document_type_key) | (document_type_key) | グローバル参照 |  |
| Numbering | document_numbering_rules | tenant | Y | Y | Y | Y | id(UUID) | - | document_type_key→document_types | (tenant_id, document_type_key) | (tenant_id, document_type_key) | prefix変更可 |  |
| Numbering | document_number_counters | tenant | Y | Y | Y | Y | id(UUID) | - | - | (tenant_id, doc_type, scope_kind, scope_id) | (tenant_id, doc_type, scope_kind, scope_id) | 遅延作成 |  |
| UoM | uom_groups | tenant | Y | Y | Y | Y | id(UUID) | uom_group_code（tenant内/原則変更禁止） | base_uom_id→uoms | (tenant_id, uom_group_code) | (tenant_id, uom_group_code) | 循環FK/DEFERRABLE |  |
| UoM | uoms | tenant | Y | Y | Y | Y | id(UUID) | uom_code（tenant内/原則変更禁止） | uom_group_id→uom_groups | (tenant_id, uom_code) | (tenant_id, uom_code) | 循環FK/DEFERRABLE |  |

> ※上表はサンプル。実際は全テーブルを網羅して行追加する。

---

### 4A-2. 棚卸しの自動判定メモ（RAG判定のコツ）
- **R（即修正）**になりやすい：
  - tenantテーブルで tenant_id が無い／RLSが無い
  - SoftDelete方針があるのに is_active が無い（または例外の理由が無い）
  - 履歴を持つのに UNIQUE が履歴軸を含まない（例：stable_id単独一意）
  - NULL運用があるのに UNIQUEで重複を止められない（DB仕様未考慮）
- **A（要チケット）**になりやすい：
  - polymorphicでFKが無い（担保策が“テスト＋整合バッチ”まで落ちていない）
  - コード再利用（is_active=false後）方針が未決（UNIQUE設計と衝突）
  - 主要検索のインデックスが未確定（性能検証前提）

---

## 4B. RLSポリシー設計テンプレ（CRUD別：必須証跡）
> 目的：tenant_idの“存在”ではなく、**隔離が“成立”している**ことを証跡化する  
> 原則：tenant Scopeの全テーブルに **SELECT/INSERT/UPDATE/DELETE** の方針が必要（例外は明記）

### 4B-1. ポリシー定義テンプレ（テーブル単位）
- 記入ルール：
  - **Context**：アプリがセッションに設定するテナント識別子（例：`app.tenant_id`）を想定
  - **USING**：参照・更新・削除時の行フィルタ
  - **WITH CHECK**：挿入・更新時に許す条件（tenant_idの注入を防ぐ）
  - **Role**：app_user / tenant_admin / system_admin（例）など、運用ロール単位で書く
  - **Exception**：移行・バッチ等の“バイパス”は明示（監査とセット）

| Table | Scope | Role | SELECT（USING） | INSERT（WITH CHECK） | UPDATE（USING / WITH CHECK） | DELETE（USING） | Bypass/Exception | Notes | RAG |
|---|---|---|---|---|---|---|---|---|---|
| employees | tenant | app_user | tenant_id = current_tenant | tenant_id = current_tenant | tenant_id = current_tenant / tenant_id = current_tenant | tenant_id = current_tenant | migration_roleのみ | 物理削除なし（is_active） |  |
| parties | tenant | app_user | tenant_id = current_tenant | tenant_id = current_tenant | tenant_id = current_tenant / tenant_id = current_tenant | tenant_id = current_tenant | migration_roleのみ | code変更禁止方針 |  |
| currencies | global | app_user | TRUE（参照専用） | N/A | N/A | N/A | system_adminのみ編集可（原則しない） | global定義 |  |
| segment_assignments | tenant | app_user | tenant_id = current_tenant | tenant_id = current_tenant | tenant_id = current_tenant / tenant_id = current_tenant | tenant_id = current_tenant | migration_roleのみ | polymorphic整合注意 |  |

#### 4B-1a. RLSの“例外”を許容する場合の必須条件
例外（migration/batch/system_admin等）を持つ場合は、最低限次を満たす：
- 例外ロールの利用シナリオが明記されている（いつ、誰が、何のために）
- 例外ロールの操作は監査対象（監査ログ or DB監査）
- 例外ロールは通常アプリ経路から利用できない（秘密管理・IP制限等）

---

### 4B-2. RLS運用チェック（本番ゲート向け）
| ID | チェック | 受け入れ基準 | 証跡 | R/A/G | アクション |
|---|---|---|---|---|---|
| RLS-01 | current_tenantの注入 | アプリが必ずセッションに tenant を設定し、未設定時は拒否 | 実装/テスト |  |  |
| RLS-02 | WITH CHECK | INSERT/UPDATEで tenant_idのなりすましが不可能 | DDL/テスト |  |  |
| RLS-03 | JOIN漏れ | 参照先テーブルにもRLSが適用され、横断漏洩がない | テスト |  |  |
| RLS-04 | 管理者権限 | tenant_adminが越境できない（system_adminのみ例外） | テスト |  |  |
| RLS-05 | 移行手順 | 移行時のロール・手順・ログが定義済 | runbook |  |  |

---

## 4C. “チェックが実装に落ちる” ための最小テスト観点（推奨）
> 目的：RLS/制約/論理削除が「仕様にある」だけでなく「壊れていない」ことを継続検証する

| TestID | 種別 | 観点 | 期待結果 | 優先度 | RAG |
|---|---|---|---|---|---|
| T-SEC-01 | セキュリティ | テナントAで作成した行がテナントBで見えない | 0件 | P0 |  |
| T-SEC-02 | セキュリティ | INSERT時に別tenant_idを指定しても拒否される | エラー | P0 |  |
| T-DATA-01 | 整合性 | departments：同stable_idを別versionで登録できる | OK | P0 |  |
| T-DATA-02 | 整合性 | Seat：MVP(NULL)運用で重複登録が防止される | 拒否 | P0 |  |
| T-LIFE-01 | ライフサイクル | is_active=falseで一覧から除外/参照は要件通り | OK | P1 |  |
| T-PERF-01 | 性能 | code検索がSLO内で返る（目標値は別途） | OK | P1 |  |

---

## 5. まとめ（判定欄）
- Rが残っているチェック：  
  - （例）X-002 / X-401 / I-005 / S-003 …など
- 次にSpec Freezeへ取り込む修正チケット：  
  - （例）is_active×UNIQUEの再利用方針  
  - （例）SKU組合せ一意担保の戦略（hash/アプリ制約/重複検知）  
  - （例）polymorphic割当の整合性バッチ（定期検査）

最終判定：**[ ] Design Ready / [ ] Implementation Ready / [ ] Release Ready / [ ] Production Ready**
（判定日：____ / 判定者：____）

---

## 6. エンティティ別セルフチェック（各MD末尾に貼付）
> 目的：各エンティティ定義MDの末尾に貼付し、個別エンティティの品質を自己チェックする
> 運用：プロジェクト全体のGate判定は上記セクション、個別エンティティの管理は本テンプレを使用

### 6.1 ビジネス意味（業務で壊れない）
| カテゴリ | チェック | RAG | 根拠/リンク | メモ |
|---|---|---|---|---|
| 意味 | このエンティティの「業務上の正体」が一文で言える |  |  |  |
| 粒度 | 1行=何を表すか（集約/明細/履歴）が明確 |  |  |  |
| ライフサイクル | 作成→更新→無効化→削除の運用が定義されている |  |  |  |
| 例外 | 「未設定」「不明」「廃止」などの例外値の扱いが定義されている |  |  |  |

### 6.2 キー/コード（ユニーク・採番・変更禁止）
| カテゴリ | チェック | RAG | 根拠/リンク | メモ |
|---|---|---|---|---|
| PK | PK（uuid等）が全テーブルで統一されている |  |  |  |
| 業務コード | 業務コードのルールが明記され、破れない仕組みがある（CHECK/採番/バリデーション） |  |  |  |
| 変更禁止 | 業務コードが変更不可か、変更可なら履歴/参照整合が定義されている |  |  |  |
| 採番 | 採番のスコープ（テナント/会社/部門/期間）が明記され、衝突しない |  |  |  |

### 6.3 リレーション/制約（参照整合が壊れない）
| カテゴリ | チェック | RAG | 根拠/リンク | メモ |
|---|---|---|---|---|
| FK | 全FKがtenant_idを含む形で定義される（例外は理由を明記） |  |  |  |
| 一意 | UNIQUEの粒度が業務要件と一致（stable/versionなど） |  |  |  |
| CHECK | 日付整合、状態遷移、型分岐（typeごとの必須）などがCHECKで表現されている |  |  |  |
| NULL運用 | NULLを許容するカラムは「NULLの意味」が仕様で説明されている |  |  |  |
| NULL×UNIQUE | NULL運用時の重複防止策（partial unique等）が明記されている |  |  |  |

### 6.4 監査/セキュリティ（説明責任を満たす）
| カテゴリ | チェック | RAG | 根拠/リンク | メモ |
|---|---|---|---|---|
| 監査 | created_at/updated_at/actorが必要十分（参照専用例外は明記） |  |  |  |
| RLS | tenant境界がRLSで担保される（tenant_id無しはガード手段が明記） |  |  |  |
| 論理削除 | 物理削除禁止、is_active=false運用が明記されている |  |  |  |
| 監査ログ | 重要イベント（承認、削除、取消等）が監査ログに残る |  |  |  |

### 6.5 性能/運用（本番で詰まない）
| カテゴリ | チェック | RAG | 根拠/リンク | メモ |
|---|---|---|---|---|
| Index | 検索・JOIN・一覧に必要なIndexが定義されている |  |  |  |
| 並行更新 | 採番/更新競合の対策（行ロック/トランザクション/リトライ）が定義されている |  |  |  |
| データ移行 | 初期移行・マスタ整備の手順（最低限）が定義されている |  |  |  |
| 監視 | 障害時に追えるログ/メトリクス（最低限）が定義されている |  |  |  |

### 6.6 Gate別 最低合格ライン（個別エンティティ向け）
- **G1（Design Ready）**：ビジネス意味がGREEN、キー/制約がAMBER以内、REDゼロ
- **G2（Implementation Ready）**：RLS/採番/監査がGREEN、DDL整合がGREEN、REDゼロ
- **G3（Release Ready）**：例外系（取消/差戻/削除/改定）と並行更新がGREEN or AMBER（暫定運用明記）
- **G4（Production Ready）**：監査・復旧・性能・運用手順がGREEN、REDゼロ

---

（このチェック表を各エンティティ定義MD末尾にコピーして使用すること）

---
