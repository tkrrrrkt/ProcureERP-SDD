# 0. 共通（このファイル内）

- 本ファイルは「通貨・銀行・倉庫」に関する共通マスタを定義する。
- マルチテナントの扱い
  - `currencies` はグローバル参照（`tenant_id` を持たない）
  - `banks` / `bank_branches` はテナント別管理（初期投入で全銀協マスタを同期してもよい）
  - `warehouse_groups` / `warehouses` はテナント別管理
- 監査列は統一する（全テーブル）
  - `created_at` / `created_by_login_account_id` / `updated_at` / `updated_by_login_account_id`
- `is_active=false` となった「コード」の再利用は原則禁止（移行時例外のみ）
- 文字列の表記
  - `*_code` は人が扱うコード（原則「変更禁止」運用）
  - `*_name_kana` は検索・並び替え用途（濁点・半角などはUIで正規化）

---

## 1. currencies（通貨マスタ）

### 仕様概要
- ISO 4217 の通貨コードを前提とする（例：JPY / USD）。
- グローバル参照（全テナント共通）。テナント個別に追加・変更しない。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | CUR-...   | PK |
| currency_code                | varchar(3)    | NO   | JPY       | ISO 4217 |
| currency_name                | varchar(50)   | NO   | 日本円    | 表示名 |
| currency_symbol              | varchar(10)   | YES  | ¥         | 表示用 |
| decimal_places               | smallint      | NO   | 0         | JPY=0, USD=2 など |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- UNIQUE(currency_code)
- CHECK(currency_code ~ '^[A-Z]{3}$')
- CHECK(decimal_places BETWEEN 0 AND 6)

### 補足
- 通貨の追加・更新は運用上「システム管理者のみ」想定（SaaS側の配布・同期も可）。

---

## 2. banks（銀行マスタ）

### 仕様概要
- 銀行コード（4桁）をキーとして管理する。
- テナント別に保持するが、初期投入で全銀協マスタの同期（または参照）を想定。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | BNK-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| bank_code                    | varchar(4)    | NO   | 0001      | 全銀協：4桁 |
| bank_name                    | varchar(100)  | NO   | みずほ銀行 | |
| bank_name_kana               | varchar(150)  | YES  | ﾐｽﾞﾎｷﾞﾝｺｳ | 検索用 |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- UNIQUE(tenant_id, bank_code)
- CHECK(bank_code ~ '^\d{4}$')

---

## 3. bank_branches（支店マスタ）

### 仕様概要
- 支店コード（3桁）をキーとして、銀行（banks）配下で管理する。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | BRN-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| bank_id                      | uuid          | NO   | BNK-...   | FK→banks |
| branch_code                  | varchar(3)    | NO   | 001       | 全銀協：3桁 |
| branch_name                  | varchar(100)  | NO   | 本店      | |
| branch_name_kana             | varchar(150)  | YES  | ﾎﾝﾃﾝ      | 検索用 |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- FK(tenant_id, bank_id) → banks(tenant_id, id)
- UNIQUE(tenant_id, bank_id, branch_code)
- CHECK(branch_code ~ '^\d{3}$')

---

## 4. payee_bank_accounts（支払先口座）

### 仕様概要
- 支払先（payees）に紐づく振込口座を管理する。
- 「支払先につき、既定口座は最大1つ」を保証する。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | PBA-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| payee_id                     | uuid          | NO   | PAY-...   | FK→payees |
| bank_id                      | uuid          | NO   | BNK-...   | FK→banks |
| bank_branch_id               | uuid          | NO   | BRN-...   | FK→bank_branches |
| account_type                 | varchar(20)   | NO   | ordinary  | ordinary/current/savings 等 |
| account_no                   | varchar(8)    | NO   | 1234567   | 1〜8桁 |
| account_holder_name          | varchar(100)  | NO   | ｺｲｽﾞﾐ ﾄﾓﾕｷ | |
| account_holder_name_kana     | varchar(150)  | YES  | ｺｲｽﾞﾐ ﾄﾓﾕｷ | 検索用 |
| is_default                   | boolean       | NO   | true      | 既定口座 |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- FK(tenant_id, payee_id) → payees(tenant_id, id)
- FK(tenant_id, bank_id) → banks(tenant_id, id)
- FK(tenant_id, bank_branch_id) → bank_branches(tenant_id, id)
- CHECK(account_no ~ '^\d{1,8}$')
- CHECK(account_type IN ('ordinary','current','savings'))

### 補足（既定口座の一意制約）
- PostgreSQL 想定の推奨（部分一意制約）
  - UNIQUE(tenant_id, payee_id) WHERE is_default = true AND is_active = true
- 代替（DBで部分一意が難しい場合）
  - アプリ層で「既定を true にする前に同一 payee の既定を解除」する。

---

## 5. warehouse_groups（倉庫グループ）

### 仕様概要
- 倉庫をグルーピングする（分析・権限・既定倉庫などの拡張余地）。
- MVPでは「任意（未使用でもよい）」。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | WHG-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| warehouse_group_code         | varchar(10)   | NO   | 00001     | 変更原則禁止 |
| warehouse_group_name         | varchar(100)  | NO   | 本社倉庫群 | |
| notes                        | text          | YES  |           | |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- UNIQUE(tenant_id, warehouse_group_code)

---

## 6. warehouses（倉庫）

### 仕様概要
- 受入／保管場所としての倉庫を管理する。
- 在庫ロケーション（棚番）などの詳細はV2以降で拡張する。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | WH-...    | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| warehouse_code               | varchar(10)   | NO   | 00001     | 変更原則禁止 |
| warehouse_name               | varchar(100)  | NO   | 本社倉庫  | |
| warehouse_group_id           | uuid          | YES  | WHG-...   | FK→warehouse_groups |
| address                      | text          | YES  |           | MVPは1項目でよい（必要なら別分割はV2） |
| is_default_receiving         | boolean       | NO   | true      | 受入既定 |
| notes                        | text          | YES  |           | |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- UNIQUE(tenant_id, warehouse_code)
- FK(tenant_id, warehouse_group_id) → warehouse_groups(tenant_id, id)

---

以上。
