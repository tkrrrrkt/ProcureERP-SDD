# 0. 共通（このファイル内）

- 本ファイルは「通貨・銀行・口座・倉庫」に関する共通マスタを定義する。
- **エンティティ一覧**:
  1. `currencies` - 通貨マスタ
  2. `banks` - 銀行マスタ
  3. `bank_branches` - 支店マスタ
  4. `payee_bank_accounts` - 支払先口座（振込先）
  5. `company_bank_accounts` - 自社口座（出金元）
  6. `warehouse_groups` - 倉庫グループ
  7. `warehouses` - 倉庫
- マルチテナントの扱い
  - `currencies` はグローバル参照（`tenant_id` を持たない）
  - `banks` / `bank_branches` はテナント別管理（MVP時点では手動登録、将来的に全銀協マスタ同期を想定）
  - `payee_bank_accounts` / `company_bank_accounts` はテナント別管理
  - `warehouse_groups` / `warehouses` はテナント別管理
- 監査列は統一する（全テーブル）
  - `created_at` / `created_by_login_account_id` / `updated_at` / `updated_by_login_account_id`
- `is_active=false` となった「コード」の再利用は原則禁止（移行時例外のみ）
- 文字列の表記
  - `*_code` は人が扱うコード（原則「変更禁止」運用）
  - `*_name_kana` は検索・並び替え用途（半角カナに正規化して保存）

---

## 1. currencies（通貨マスタ）

### 仕様概要
- ISO 4217 の通貨コードを前提とする（例：JPY / USD）。
- グローバル参照（全テナント共通）。テナント個別に追加・変更しない。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | CUR-...   | PK |
| currency_code                | varchar(3)    | NO   | JPY       | ISO 4217 |
| currency_name                | varchar(50)   | NO   | 日本円    | 表示名 |
| currency_symbol              | varchar(10)   | YES  | ¥         | 表示用 |
| decimal_places               | smallint      | NO   | 0         | JPY=0, USD=2 など |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- UNIQUE(currency_code)
- CHECK(currency_code ~ '^[A-Z]{3}$')
- CHECK(decimal_places BETWEEN 0 AND 6)

### 補足
- 通貨の追加・更新は運用上「システム管理者のみ」想定（SaaS側の配布・同期も可）。

---

## 2. banks（銀行マスタ）

### 仕様概要
- 銀行コード（4桁）をキーとして管理する。
- テナント別に保持する（MVP時点では手動登録、将来的に全銀協マスタ同期を想定）。
- ゆうちょ銀行は通常の銀行として登録（銀行コード：9900）。
- 統廃合への対応は論理削除（is_active=false）のみ。承継コード管理は行わない。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | BNK-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| bank_code                    | varchar(4)    | NO   | 0001      | 全銀協：4桁 |
| bank_name                    | varchar(100)  | NO   | みずほ銀行 | |
| bank_name_kana               | varchar(150)  | YES  | ﾐｽﾞﾎｷﾞﾝｺｳ | 検索用（半角カナ） |
| swift_code                   | varchar(11)   | YES  | MHCBJPJT  | 将来対応用（8-11桁） |
| display_order                | integer       | NO   | 1000      | 表示順（小さい順に表示） |
| is_active                    | boolean       | NO   | true      | 論理削除 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- UNIQUE(tenant_id, bank_code)
- CHECK(bank_code ~ '^\d{4}$')
- CHECK(swift_code IS NULL OR swift_code ~ '^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?$')
- CHECK(display_order > 0)

### UI機能（MVP）
- 一覧画面：カナ検索（インクリメンタル）対応、表示順でソート
- 詳細画面：基本情報＋支店一覧タブ
- 登録/編集/論理削除（CRUD）
- 配置：マスタ管理 > 共通 > 銀行

---

## 3. bank_branches（支店マスタ）

### 仕様概要
- 支店コード（3桁）をキーとして、銀行（banks）配下で管理する。
- 支店種別（本店・支店・出張所等）の区分は持たない（シンプル運用）。
- 支店の住所情報はMVPでは持たない。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | BRN-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| bank_id                      | uuid          | NO   | BNK-...   | FK→banks |
| branch_code                  | varchar(3)    | NO   | 001       | 全銀協：3桁 |
| branch_name                  | varchar(100)  | NO   | 本店      | |
| branch_name_kana             | varchar(150)  | YES  | ﾎﾝﾃﾝ      | 検索用（半角カナ） |
| display_order                | integer       | NO   | 1000      | 表示順（小さい順に表示） |
| is_active                    | boolean       | NO   | true      | 論理削除 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- FK(tenant_id, bank_id) → banks(tenant_id, id)
- UNIQUE(tenant_id, bank_id, branch_code)
- CHECK(branch_code ~ '^\d{3}$')
- CHECK(display_order > 0)

### UI機能（MVP）
- 銀行詳細画面内の「支店一覧」タブで表示
- カナ検索（インクリメンタル）対応
- 登録/編集/論理削除（CRUD）

---

## 4. payee_bank_accounts（支払先口座）

### 仕様概要
- 支払先（payees）に紐づく振込口座を管理する。
- 「支払先につき、既定口座は最大1つ」を保証する。
- 複数の支払先が同じ銀行口座を指定するケースは考慮しない（支払先ごとに別レコード）。
- 口座名義人と支払先名が異なる場合のチェックは行わない（通常の運用として許容）。
- **口座区分**により、銀行・ゆうちょ・農協を区別して管理する。
- **振込手数料負担**を口座単位で設定し、支払処理時に参照する。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | PBA-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| payee_id                     | uuid          | NO   | PAY-...   | FK→payees |
| account_category             | varchar(20)   | NO   | bank      | **口座区分**: bank/post_office/ja_bank |
| bank_id                      | uuid          | YES  | BNK-...   | FK→banks（bank/ja_bank時は必須） |
| bank_branch_id               | uuid          | YES  | BRN-...   | FK→bank_branches（bank/ja_bank時は必須） |
| post_office_symbol           | varchar(5)    | YES  | 10000     | ゆうちょ記号（post_office時は必須） |
| post_office_number           | varchar(8)    | YES  | 12345678  | ゆうちょ番号（post_office時は必須） |
| account_type                 | varchar(20)   | NO   | ordinary  | ordinary/current/savings/other |
| account_no                   | varchar(7)    | YES  | 0001234   | 7桁（bank/ja_bank時は必須） |
| account_holder_name          | varchar(100)  | NO   | コイズミ トモユキ | 全角カタカナ（自動変換） |
| account_holder_name_kana     | varchar(150)  | YES  | ｺｲｽﾞﾐ ﾄﾓﾕｷ | 検索用（半角カナ自動変換） |
| transfer_fee_bearer          | varchar(20)   | NO   | sender    | **振込手数料負担**: sender/recipient |
| is_default                   | boolean       | NO   | true      | 既定口座 |
| is_active                    | boolean       | NO   | true      | 論理削除 |
| notes                        | text          | YES  |           | 備考（振込時の注意事項等） |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | YES  | ACC-...   | 監査（**実質必須**） |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | YES  | ACC-...   | 監査（**実質必須**） |

### 制約条件
- FK(tenant_id, payee_id) → payees(tenant_id, id)
- FK(tenant_id, bank_id) → banks(tenant_id, id)  -- NULLable
- FK(tenant_id, bank_branch_id) → bank_branches(tenant_id, id)  -- NULLable
- CHECK(account_category IN ('bank','post_office','ja_bank'))
- CHECK(account_type IN ('ordinary','current','savings','other'))
- CHECK(transfer_fee_bearer IN ('sender','recipient'))
- CHECK(account_no IS NULL OR account_no ~ '^\d{7}$')
- CHECK(post_office_symbol IS NULL OR post_office_symbol ~ '^\d{5}$')
- CHECK(post_office_number IS NULL OR post_office_number ~ '^\d{1,8}$')
- **条件付き必須制約（アプリ層で実装）**:
  - account_category = 'bank' OR 'ja_bank' → bank_id, bank_branch_id, account_no は必須
  - account_category = 'post_office' → post_office_symbol, post_office_number は必須

### 口座区分の定義
| コード | 日本語名 | 説明 | コード体系 |
|--------|----------|------|------------|
| bank | 銀行 | 一般銀行（全銀システム） | 銀行コード4桁 + 支店コード3桁 + 口座番号7桁 |
| post_office | ゆうちょ銀行 | 郵便局（ゆうちょ銀行） | 記号5桁 + 番号最大8桁 |
| ja_bank | 農協 | JAバンク（農業協同組合） | 銀行コード4桁 + 支店コード3桁 + 口座番号7桁 |

### 口座種別の定義
| コード | 日本語名 | 説明 |
|--------|----------|------|
| ordinary | 普通 | 普通預金口座 |
| current | 当座 | 当座預金口座 |
| savings | 貯蓄 | 貯蓄預金口座 |
| other | その他 | 上記以外の口座種別 |

### 振込手数料負担の定義
| コード | 日本語名 | 説明 | 支払処理での動作 |
|--------|----------|------|------------------|
| sender | 当社負担 | 振込手数料は自社が負担 | 振込額 = 請求額（手数料は別途自社負担） |
| recipient | 先方負担 | 振込手数料は先方が負担 | 振込額 = 請求額 - 振込手数料 |

### データ変換ルール
- **口座番号**: 入力値を7桁にゼロ埋め（例：1234 → 0001234）
- **口座名義人**: 入力値を全角カタカナに変換して保存
- **口座名義人カナ（検索用）**: 入力値を半角カナに変換して保存
- **ゆうちょ記号**: 5桁に正規化（例：10000）
- **ゆうちょ番号**: 最大8桁、先頭ゼロは保持

### ゆうちょ銀行の全銀システム変換（参考）
ゆうちょ銀行を全銀システム経由で振込する場合の変換ルール：
- 銀行コード: `9900`（固定）
- 支店コード: 記号の2-3桁目 + `8`（例：記号10000 → 支店コード008）
- 口座番号: 番号の末尾1桁を除いた7桁（例：12345671 → 1234567）

※変換は振込データ生成時にアプリ層で実施。DBには記号・番号のまま保持する。

### 補足（既定口座の一意制約）
- PostgreSQL 想定の推奨（部分一意制約）
  - UNIQUE(tenant_id, payee_id) WHERE is_default = true AND is_active = true
- 代替（DBで部分一意が難しい場合）
  - アプリ層で「既定を true にする前に同一 payee の既定を解除」する。

### UI機能（MVP）
- 支払先口座登録画面から銀行・支店を選択するモーダル検索
- **口座区分選択**: 銀行 / ゆうちょ銀行 / 農協 のラジオボタン
- **銀行/農協選択時**:
  - 銀行選択：カナ検索（インクリメンタル）→ 選択
  - 支店選択：銀行選択後に支店一覧を表示 → カナ検索 → 選択
  - 口座種別・口座番号・口座名義人を入力
- **ゆうちょ銀行選択時**:
  - 記号（5桁）・番号（最大8桁）を直接入力
  - 口座名義人を入力
- **振込手数料負担**: 当社負担 / 先方負担 のラジオボタン（デフォルト：当社負担）
- 銀行が見つからない場合は管理者に依頼（一般ユーザーは銀行追加不可）

---

## 5. company_bank_accounts（自社口座 / 出金口座）

### 仕様概要
- 自社の銀行口座（振込時の出金元）を管理する。
- 支払処理時に「どの口座から出金するか」を選択する。
- テナントにつき既定出金口座は最大1つを保証する。
- 全銀フォーマット（FB）出力時の依頼人情報として使用する。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | CBA-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| account_code                 | varchar(10)   | NO   | 001       | 管理用コード（テナント内一意） |
| account_name                 | varchar(100)  | NO   | 本社普通口座 | 表示用名称 |
| account_category             | varchar(20)   | NO   | bank      | 口座区分: bank/post_office |
| bank_id                      | uuid          | YES  | BNK-...   | FK→banks（bank時は必須） |
| bank_branch_id               | uuid          | YES  | BRN-...   | FK→bank_branches（bank時は必須） |
| post_office_symbol           | varchar(5)    | YES  | 10000     | ゆうちょ記号（post_office時は必須） |
| post_office_number           | varchar(8)    | YES  | 12345678  | ゆうちょ番号（post_office時は必須） |
| account_type                 | varchar(20)   | NO   | ordinary  | ordinary/current/savings |
| account_no                   | varchar(7)    | YES  | 0001234   | 7桁（bank時は必須） |
| account_holder_name          | varchar(100)  | NO   | カ）プロキュア | 口座名義人（全角カタカナ） |
| account_holder_name_kana     | varchar(150)  | YES  | ｶ)ﾌﾟﾛｷｭｱ   | 検索用（半角カナ） |
| consignor_code               | varchar(10)   | YES  | 1234567890 | 委託者コード（全銀FB用、10桁） |
| is_default                   | boolean       | NO   | false     | 既定出金口座 |
| is_active                    | boolean       | NO   | true      | 論理削除 |
| notes                        | text          | YES  |           | 備考 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | YES  | ACC-...   | 監査（**実質必須**） |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | YES  | ACC-...   | 監査（**実質必須**） |

### 制約条件
- UNIQUE(tenant_id, account_code)
- FK(tenant_id, bank_id) → banks(tenant_id, id)  -- NULLable
- FK(tenant_id, bank_branch_id) → bank_branches(tenant_id, id)  -- NULLable
- CHECK(account_category IN ('bank','post_office'))
- CHECK(account_type IN ('ordinary','current','savings'))
- CHECK(account_no IS NULL OR account_no ~ '^\d{7}$')
- CHECK(consignor_code IS NULL OR consignor_code ~ '^\d{10}$')
- **部分一意制約（既定口座）**:
  - UNIQUE(tenant_id) WHERE is_default = true AND is_active = true

### 補足事項
- **委託者コード（consignor_code）**: 全銀協フォーマット（FB）で振込データを作成する際の依頼人識別コード。銀行から付与される10桁の番号。
- **account_name**: 画面上での識別用。複数口座を持つ場合に区別しやすい名称を設定（例：「本社普通口座」「経理部当座口座」）。
- 農協口座は自社口座としてはレアケースのため、MVPでは bank / post_office のみ対応。

### UI機能（MVP）
- 自社口座一覧画面（マスタ管理 > 共通 > 自社口座）
- 登録時に銀行/ゆうちょを選択
- 既定口座の設定（1テナント1口座のみ既定可）
- 支払処理画面から出金口座を選択可能

---

## 6. warehouse_groups（倉庫グループ）

### 仕様概要
- 倉庫をグルーピングする（分析・権限・既定倉庫などの拡張余地）。
- **MVPでは「エンティティのみ」**：UI実装は行わない。
- warehouse_group_id は nullable のため、倉庫グループなしでも倉庫登録可能。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | WHG-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| warehouse_group_code         | varchar(10)   | NO   | 00001     | 変更原則禁止 |
| warehouse_group_name         | varchar(100)  | NO   | 本社倉庫群 | |
| notes                        | text          | YES  |           | |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| version                      | integer       | NO   | 1         | 楽観ロック用 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | YES  | ACC-...   | 監査（実質必須） |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | YES  | ACC-...   | 監査（実質必須） |

### 制約条件
- UNIQUE(tenant_id, warehouse_group_code)

### UI機能
- **MVPでは未実装**（エンティティのみ）
- V2以降で倉庫グループ管理画面を実装予定

---

## 7. warehouses（倉庫）

### 仕様概要
- 受入／保管場所としての倉庫を管理する。
- 自社倉庫、在庫管理場所として利用する。
- 在庫ロケーション（棚番）などの詳細はV2以降で拡張する。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | WH-...    | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| warehouse_code               | varchar(10)   | NO   | 00001     | 変更原則禁止 |
| warehouse_name               | varchar(100)  | NO   | 本社倉庫  | |
| warehouse_name_kana          | varchar(200)  | YES  | ﾎﾝｼｬｿｳｺ   | 検索用（半角カナ） |
| warehouse_group_id           | uuid          | YES  | WHG-...   | FK→warehouse_groups |
| postal_code                  | varchar(10)   | YES  | 100-0001  | 郵便番号 |
| prefecture                   | varchar(20)   | YES  | 東京都    | 都道府県 |
| city                         | varchar(50)   | YES  | 千代田区  | 市区町村 |
| address_1                    | varchar(100)  | YES  | 丸の内1-1-1 | 住所1 |
| address_2                    | varchar(100)  | YES  | 丸の内ビル10F | 住所2 |
| phone_number                 | varchar(20)   | YES  | 03-1234-5678 | 電話番号 |
| is_default_receiving         | boolean       | NO   | false     | 受入既定（テナント1つのみ） |
| display_order                | integer       | NO   | 1000      | 表示順（小さい順に表示） |
| notes                        | text          | YES  |           | |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| version                      | integer       | NO   | 1         | 楽観ロック用 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| created_by_login_account_id  | uuid          | YES  | ACC-...   | 監査（実質必須） |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z |  |
| updated_by_login_account_id  | uuid          | YES  | ACC-...   | 監査（実質必須） |

### 制約条件
- UNIQUE(tenant_id, warehouse_code)
- FK(tenant_id, warehouse_group_id) → warehouse_groups(tenant_id, id)
- CHECK(display_order > 0)
- **部分一意制約（既定受入倉庫）**:
  - UNIQUE(tenant_id) WHERE is_default_receiving = true AND is_active = true

### UI機能（MVP）
- 倉庫一覧画面（マスタデータ > 倉庫）
- カナ検索（インクリメンタル）対応
- 登録/編集/論理削除（CRUD）
- 既定受入倉庫の設定（1テナント1倉庫のみ既定可）
- 発注・入荷画面から倉庫を選択可能

---

以上。
