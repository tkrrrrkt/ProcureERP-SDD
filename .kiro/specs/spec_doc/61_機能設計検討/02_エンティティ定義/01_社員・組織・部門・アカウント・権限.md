# エンティティ定義：社員・組織・部門・アカウント・権限

> 本ドキュメントは、**購買管理SaaS（ProcureERP）における共通基盤エンティティ**として、 社員・組織・部門・所属履歴・アカウント・権限を定義する。
> 
> 本定義は **マルチテナントSaaSを前提**とし、購買業務（申請・承認・監査）に必要な 組織改編耐性・説明責任・再現性を最優先に設計している。

---

## 1. 仕様の概要

### 1.1 対象エンティティ

- 社員（employees）
    
- 社員所属履歴（employee_assignments）
    
- 組織バージョン（organization_versions）
    
- 部門（departments）
    
- ログインアカウント（login_accounts）
    
- ロール（roles）
    
- アカウントロール付与（login_account_roles）
    

### 1.2 基本設計方針

- **tenant_id を唯一のテナント境界**とする（CompanyIDは持たない）
    
- 社員＝「人」、アカウント＝「認証主体」を分離
    
- 組織は **スナップショット（版）管理**を行い、 部門は **stable_id（版非依存ID）**を持つ
    
- 社員の所属・役割・承認責務は履歴テーブルで期間管理
    
- 権限は **RBAC（ロールベース）**を最小構成で実装し、 購買特有の制御（承認上限等）は後続拡張で担保
    

---

## 2. エンティティ定義

---

### 2.1 employees（社員）

#### 仕様の概要

- 社員という「人」を表す基本マスタ
    
- 異動・兼務・役職・承認責務は保持しない
    

#### エンティティ定義

|項目|型|必須|例|備考|
|---|---|---|---|---|
|id|uuid|◯|EMP-...|PK|
|tenant_id|uuid|◯|TEN-...|RLS境界|
|employee_code|varchar(30)|◯|"E00123"|テナント内一意|
|employee_name|varchar(100)|◯|"山田 太郎"||
|employee_name_kana|varchar(100)|◯|"ヤマダ タロウ"|カナ名（検索・ソート用、MVP-1では必須）|
|email|text||"taro@..."|連絡用|
|join_date|date||2020-04-01|入社日|
|retire_date|date||2026-03-31|退職日|
|remarks|text||"特記事項"|備考（任意）|
|is_active|boolean|◯|true|論理無効|
|version|int|◯|1|楽観ロック|
|created_at|timestamptz|◯|||
|updated_at|timestamptz|◯|||
|created_by_login_account_id|uuid||ACC-...|作成者（login_accounts.id）|
|updated_by_login_account_id|uuid||ACC-...|更新者（login_accounts.id）|

#### 制約事項

- UNIQUE(tenant_id, employee_code)

#### インデックス

- INDEX(tenant_id, employee_code) - 検索・一覧取得の高速化
- INDEX(tenant_id, is_active) - 有効社員のフィルタリング高速化
- INDEX(tenant_id, join_date) - 入社日範囲検索・ソートの高速化

#### 補足事項

- 人事マスタは外部に存在しても、購買承認・責任追跡のため本エンティティは必須
- **カナ名の必須性**（MVP-1方針）
  - MVP-1では日本企業をターゲットとするため、employee_name_kana を必須とする
  - 検索（あいまい検索）および五十音順ソートに使用
  - 外国人社員の場合はローマ字表記で代用する運用とする
  - 国際化対応（カナ名任意化）はMVP-2以降で検討
- **監査列**
  - created_by_login_account_id / updated_by_login_account_id は将来 login_accounts テーブル実装時にFK制約を追加
  - MVP-1ではUUID参照として機能（FK制約なし）
- **楽観ロック**
  - version フィールドによる楽観的同時実行制御
  - 更新時に version の一致をチェックし、不一致の場合は CONCURRENT_UPDATE エラー


---

### 2.2 employee_assignments（社員所属履歴）

#### 仕様の概要

- 社員の所属部門・主務/兼務・役割を期間で管理
    
- 組織改編に耐えるため **department_stable_id** を参照
    

#### エンティティ定義

|   |   |   |   |   |
|---|---|---|---|---|
|項目|型|必須|例|備考|
|id|uuid|◯|EA-...|PK|
|tenant_id|uuid|◯|TEN-...|RLS|
|employee_id|uuid|◯|EMP-...|FK employees|
|department_stable_id|uuid|◯|DEPT-SALES|版非依存部門ID|
|assignment_type|varchar(20)|◯|primary|primary/secondary|
|allocation_ratio|numeric(5,2)||70.00|任意|
|role_in_department|varchar(100)||"部門長"|承認責務に利用|
|effective_date|date|◯|2025-04-01||
|expiry_date|date|||NULL=無期限|
|is_active|boolean|◯|true||
|created_at|timestamptz|◯|||
|updated_at|timestamptz|◯|||

#### 制約事項

- CHECK(assignment_type IN ('primary','secondary'))
    
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)
    

#### 補足事項

- 主務（primary）の期間重複は業務要件により禁止推奨
    
- 承認ルート判定は本テーブルを基点に行う
    

---

### 2.3 organization_versions（組織バージョン）

#### 仕様の概要

- 組織構造のスナップショット管理
    
- 申請・承認時点の組織を再現可能にする
    

#### エンティティ定義

|   |   |   |   |   |
|---|---|---|---|---|
|項目|型|必須|例|備考|
|id|uuid|◯|ORG-2025-04|PK|
|tenant_id|uuid|◯|TEN-...|RLS|
|version_code|varchar(20)|◯|"2025-04"|一意|
|version_name|varchar(200)|◯|"2025年4月組織改編"||
|effective_date|date|◯|2025-04-01||
|expiry_date|date|||NULL=無期限|
|description|text||||
|created_at|timestamptz|◯|||
|updated_at|timestamptz|◯|||

#### 制約事項

- UNIQUE(tenant_id, version_code)
    
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)
    

#### 補足事項

- 申請時点で有効な version を固定してワークフローを確定する
    

---

### 2.4 departments（部門）

#### 仕様の概要

- 組織版内の部門実体
    
- **stable_id** により版を跨いだ追跡が可能
    

#### エンティティ定義

|   |   |   |   |   |
|---|---|---|---|---|
|項目|型|必須|例|備考|
|id|uuid|◯|DEPT-...|PK|
|tenant_id|uuid|◯|TEN-...|RLS|
|version_id|uuid|◯|ORG-2025-04|FK organization_versions|
|stable_id|uuid|◯|DEPT-SALES|版非依存ID|
|department_code|varchar(50)|◯|"SALES_HQ"|版内一意|
|department_name|varchar(200)|◯|"営業本部"||
|parent_id|uuid|||同一version内|
|sort_order|int|◯|10||
|is_active|boolean|◯|true||
|manager_employee_id|uuid|||部門責任者（参照用/表示用。承認の正本はWFで決定）|
|created_at|timestamptz|◯|||
|updated_at|timestamptz|◯|||

#### 制約事項

- UNIQUE(tenant_id, version_id, department_code)
    
- UNIQUE(tenant_id, version_id, stable_id)
    
- parent_id は同一 version_id に限定
    

#### 補足事項

- 承認責任者は承認ルート定義で最終決定する（manager固定にしない）
- manager_employee_id は「部門の代表責任者（参照用・表示用）」であり、承認者の決定はWFルート（approval_route_steps / Seat）を正とする（manager固定運用はしない）
    

---

### 2.5 login_accounts（ログインアカウント）

#### 仕様の概要

- ログイン・認証・セキュリティ専用エンティティ
    

#### エンティティ定義

|   |   |   |   |   |
|---|---|---|---|---|
|項目|型|必須|例|備考|
|id|uuid|◯|ACC-...|PK|
|tenant_id|uuid|◯|TEN-...|RLS|
|employee_id|uuid|◯|EMP-...|FK employees|
|login_id|varchar(100)|◯|"e00123"|ログインID|
|email_login|varchar(255)||"taro@..."||
|password_hash|text|||SSO時NULL|
|auth_provider|varchar(30)|◯|"local"|local/oidc/saml|
|status|varchar(20)|◯|"active"|active/locked/disabled|
|last_login_at|timestamptz||||
|created_at|timestamptz|◯|||
|updated_at|timestamptz|◯|||

#### 制約事項

- UNIQUE(tenant_id, login_id)
    
- UNIQUE(tenant_id, employee_id)
    

#### 補足事項

- 認証方式の拡張は auth_provider で吸収
    

---

### 2.6 roles（ロール）

#### 仕様の概要

- 機能単位の役割定義
    

#### エンティティ定義

|   |   |   |   |   |
|---|---|---|---|---|
|項目|型|必須|例|備考|
|id|uuid|◯|ROLE-ADMIN|PK|
|tenant_id|uuid|◯|TEN-...|RLS|
|role_code|varchar(50)|◯|"ADMIN"|一意|
|role_name|varchar(100)|◯|"管理者"||
|is_active|boolean|◯|true||
|created_at|timestamptz|◯|||
|updated_at|timestamptz|◯|||

#### 制約事項

- UNIQUE(tenant_id, role_code)
    

---

### 2.7 login_account_roles（アカウントロール付与）

#### 仕様の概要

- アカウントに複数ロールを付与
    

#### エンティティ定義

|   |   |   |   |   |
|---|---|---|---|---|
|項目|型|必須|例|備考|
|id|uuid|◯|AR-...|PK|
|tenant_id|uuid|◯|TEN-...|RLS|
|login_account_id|uuid|◯|ACC-...|FK login_accounts|
|role_id|uuid|◯|ROLE-...|FK roles|
|created_at|timestamptz|◯|||

#### 制約事項

- UNIQUE(tenant_id, login_account_id, role_id)
    

---

## 3. 横断制約事項

- **tenant_id必須（RLS前提）**
  - 全テーブルに tenant_id カラムを持つ
  - すべてのクエリのWHERE句に tenant_id を明示（アプリケーション層ガード）
  - RLSポリシーによる二重ガード

- **RLS (Row Level Security) ポリシー標準化**
  - 全テーブルで RLS を有効化: `ALTER TABLE {table_name} ENABLE ROW LEVEL SECURITY;`
  - 標準ポリシー定義:
    ```sql
    CREATE POLICY "tenant_isolation" ON {table_name}
      FOR ALL
      USING (tenant_id = current_setting('app.current_tenant_id', true)::text);
    ```
  - アプリケーション層は接続時に `SET app.current_tenant_id = '{tenant_id}';` を実行

- **論理削除（is_active）と履歴は必ず保持**
  - 物理削除は禁止
  - is_active=false による論理無効化

- **組織改編後も過去申請・承認の再現が可能であること**

- **楽観ロック（version）の標準化**
  - 全マスタエンティティは version フィールド（int, NOT NULL, DEFAULT 1）を持つ
  - 更新時は version の一致をチェックし、不一致の場合は CONCURRENT_UPDATE エラー
  - トランザクション系エンティティは悲観ロック（FOR UPDATE）を使用

- **監査列の標準化**
  - 全エンティティは created_by_login_account_id / updated_by_login_account_id を持つ
  - login_accounts 実装後にFK制約を追加（MVP-1ではUUID参照のみ）


---

## 4. 補足事項（購買管理SaaSとしての意図）

- 本設計は「人・組織・権限」を **購買統制と監査の基盤**として扱う
    
- 承認ルート・金額上限・カテゴリ制御は後続エンティティで拡張
    
- 人事・IdP・ERP連携を前提に **疎結合**で利用可能