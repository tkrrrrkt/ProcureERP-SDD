# 伝票種類・採番 エンティティ定義
# 0. 共通
- 物理削除禁止：is_active=false により論理無効化
- 監査カラム：created_at / created_by_login_account_id / updated_at / updated_by_login_account_id
- UUID：全エンティティでPK（id）として保持（グローバル参照含む）

---

# 1. document_types（伝票種類 / DocumentType）
## 1.1 仕様概要
- 伝票種類を定義する固定マスタ
- システム固定：PR / RFQ / PO / GR / IR のみ（追加不可）
- 全テナント共通（グローバル参照）
- 参照上の正：document_type_key（固定コード）
- プロセス遷移（次伝票/自動生成等）の意味は持たない（MVPはアプリ固定ロジック）
- WF対象フラグ（wf_enabled）を保持する

## 1.2 エンティティ定義
### document_types
|列名|型|NULL|例|説明|
|---|---|---:|---|---|
|id|uuid|NO|UUID|正本PK|
|document_type_key|text|NO|`PO`|固定コード（PR/RFQ/PO/GR/IR）※参照上の正|
|name|text|NO|`発注`|表示名|
|description|text|YES|`発注伝票`|補足説明|
|wf_enabled|boolean|NO|true|WF対象フラグ|
|is_active|boolean|NO|true|論理有効|
|created_at|timestamptz|NO||作成日時|
|created_by_login_account_id|uuid|NO||作成者|
|updated_at|timestamptz|NO||更新日時|
|updated_by_login_account_id|uuid|NO||更新者|

## 1.3 制約条件
- PRIMARY KEY (id)
- UNIQUE (document_type_key)
- CHECK (document_type_key IN ('PR','RFQ','PO','GR','IR'))

## 1.4 補足事項
- 本テーブルはグローバル参照のため tenant_id を持たない
- シードデータ（固定）
  - PR：wf_enabled=true
  - RFQ：wf_enabled=false
  - PO：wf_enabled=true
  - GR：wf_enabled=false
  - IR：wf_enabled=true

---

# 2. document_numbering_rules（採番ルール：tenant別）
## 2.1 仕様概要
- tenantごとに、伝票種別単位の採番“見た目”を最小設定で制御するマスタ
- 設定できるのは以下の3点のみ
  - prefix（先頭1桁アルファ：変更可能）
  - include_department_symbol（部門記号を含めるか）
  - period_kind（期間を含めるか：なし／年／年月）
- 連番桁数はMVP固定：8桁ゼロ埋め
- 系列分割は sequence_scope_kind（全社/部門）で指定
- 期間の基準日は document_date（業務日付）を正とする

## 2.2 エンティティ定義
### document_numbering_rules
|列名|型|NULL|例|説明|
|---|---|---:|---|---|
|id|uuid|NO|UUID|正本PK|
|tenant_id|uuid|NO|TEN-...|RLS境界|
|document_type_key|text|NO|`PO`|対象種別（PR/RFQ/PO/GR/IR）|
|prefix|text|NO|`P`|先頭1桁（英大文字）|
|include_department_symbol|boolean|NO|true|部門記号を番号に含めるか|
|period_kind|text(enum)|NO|`YYMM`|期間付与：NONE/YY/YYMM|
|sequence_scope_kind|text(enum)|NO|`DEPARTMENT`|系列分割：COMPANY/DEPARTMENT|
|seq_padding|int|NO|8|SEQゼロ埋め桁数（MVP固定）|
|is_active|boolean|NO|true|論理有効|
|created_at|timestamptz|NO||作成日時|
|created_by_login_account_id|uuid|NO||作成者|
|updated_at|timestamptz|NO||更新日時|
|updated_by_login_account_id|uuid|NO||更新者|

## 2.3 制約条件
- PRIMARY KEY (id)
- UNIQUE (tenant_id, document_type_key)
- CHECK (document_type_key IN ('PR','RFQ','PO','GR','IR'))
- CHECK (seq_padding = 8)
- CHECK (prefix ~ '^[A-Z]$')  ※英大文字1文字
- CHECK (period_kind IN ('NONE','YY','YYMM'))
- CHECK (sequence_scope_kind IN ('COMPANY','DEPARTMENT'))

## 2.4 補足事項
- prefix変更は許容（以後の発番にのみ影響。過去のdocument_noは不変）
- period_kind の期間文字列は、伝票日 document_date（業務日付）を正として生成する
  - YY：西暦下2桁（例：2026-01-15 → `26`）
  - YYMM：西暦下2桁＋月2桁（例：2026-01-15 → `2601`）

---

# 3. document_number_counters（採番カウンタ：tenant別）
## 3.1 仕様概要
- 採番の現在値（next_seq_no）を保持するカウンタ
- 初回採番時に遅延作成（INSERT→ON CONFLICT）
- “全社連番”は scope_id を固定UUID（予約値）で表現し、NULL運用はしない
- 同一系列（tenant×doc_type×scope_kind×scope_id）は1行のみとし、同一行更新で競合を解決する
- 欠番は許容

## 3.2 エンティティ定義
### document_number_counters
|列名|型|NULL|例|説明|
|---|---|---:|---|---|
|id|uuid|NO|UUID|正本PK|
|tenant_id|uuid|NO|TEN-...|RLS境界|
|document_type_key|text|NO|`PO`|対象種別（PR/RFQ/PO/GR/IR）|
|sequence_scope_kind|text(enum)|NO|`DEPARTMENT`|系列分割：COMPANY/DEPARTMENT|
|scope_id|uuid|NO|DEP-STB-...|系列キー（COMPANYは固定UUID、DEPARTMENTはdepartment_stable_id）|
|next_seq_no|bigint|NO|1|次に払い出す連番（1以上）|
|is_active|boolean|NO|true|論理有効|
|created_at|timestamptz|NO||作成日時|
|created_by_login_account_id|uuid|NO||作成者|
|updated_at|timestamptz|NO||更新日時|
|updated_by_login_account_id|uuid|NO||更新者|

## 3.3 制約条件
- PRIMARY KEY (id)
- UNIQUE (tenant_id, document_type_key, sequence_scope_kind, scope_id)
- CHECK (document_type_key IN ('PR','RFQ','PO','GR','IR'))
- CHECK (sequence_scope_kind IN ('COMPANY','DEPARTMENT'))
- CHECK (next_seq_no >= 1)

## 3.4 補足事項
### 3.4.1 scope_id の固定UUID（予約値）
- COMPANYスコープの scope_id は固定UUID（予約値）を使用する
  - 例：`00000000-0000-0000-0000-000000000000`
- 上記予約UUIDは部門等の実データIDとして使用しない（予約値として扱う）

### 3.4.2 遅延作成（INSERT→ON CONFLICT）
- 初回採番時に該当系列行が存在しない場合は作成する
- 競合時は ON CONFLICT により重複作成を防止し、同一系列を1行に保つ

### 3.4.3 伝票番号（document_no）生成（区切りなし：確定）
- 生成順（区切りなし、結合のみ）
  1) prefix
  2) department_symbol（include_department_symbol=true の場合のみ）
  3) 期間文字列（period_kind=YY/YYMM の場合のみ、基準は document_date）
  4) SEQ（8桁ゼロ埋め）
- document_no は発番時に生成して凍結し、以後更新しない
- 部門記号は departments.department_symbol を使用（別仕様で文字種制限とtenant内一意を担保）

以上。
