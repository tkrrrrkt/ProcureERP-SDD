# 0. 共通（このファイル内）

- 本ファイルは「品目（品目・SKU・仕様属性）」を定義する。
- 基本方針
  - 品目（`items`）は「何を買うか／扱うか」を表すマスタ。
  - SKU（`item_variants`）は「同一品目内の具体SKU」を表す。SKUは品目内で `variant_code`（00000起点の連番）で識別する。
  - 仕様属性（`item_attributes` / `item_attribute_values`）は「SKUの仕様の粒度」を定義する（例：色、サイズ）。
  - SKUと仕様属性値の組合せ（`item_variant_attributes`）によりSKUを確定する（= VARIANT_KEY）。
  - 自由入力（フリーテキスト）仕様は **V2（在庫/ロット/シリアル/インスタンス）** で扱う。MVPのSKU仕様は **選択肢（master値）** のみ。
- 監査列は統一する（全テーブル）
  - `created_at` / `created_by_login_account_id` / `updated_at` / `updated_by_login_account_id`
- `is_active=false` となった「コード」の再利用は原則禁止（移行時例外のみ）

---

## 1. items（品目）

### 仕様概要
- 品目コードはテナント内で一意。
- 1品目に対し、必ず「基底SKU（variant_code='00000'）」を1つ持つ。
- 単位は `uoms`（09_単位・単位グループ.md）を参照する。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | ITM-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| item_code                    | varchar(20)   | NO   | 00001     | 変更原則禁止（社内コード） |
| item_name                    | varchar(200)  | NO   | 六角ボルトM6 | |
| item_short_name              | varchar(100)  | YES  | ボルトM6  | |
| base_uom_id                  | uuid          | NO   | UOM-...   | FK→uoms（基本単位） |
| purchase_uom_id              | uuid          | YES  | UOM-...   | FK→uoms（購買単位） |
| default_variant_id           | uuid          | NO   | VAR-...   | FK→item_variants（variant_code='00000' を指す） |
| notes                        | text          | YES  |           | |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- UNIQUE(tenant_id, item_code)
- FK(tenant_id, base_uom_id) → uoms(tenant_id, id)
- FK(tenant_id, purchase_uom_id) → uoms(tenant_id, id)
- FK(tenant_id, default_variant_id) → item_variants(tenant_id, id)

### 補足
- `purchase_uom_id` は任意。設定する場合は **base_uom と同一の uom_group に属すること**（=変換可能）をアプリ層で検証する。

---

## 2. item_attributes（品目仕様属性）

### 仕様概要
- SKUの仕様を定義する軸（例：色、サイズ）。
- MVPでは「選択肢（`item_attribute_values`）から選ぶ」前提。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | IAT-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| item_attribute_code          | varchar(20)   | NO   | COLOR     | 変更原則禁止 |
| item_attribute_name          | varchar(100)  | NO   | 色        | |
| value_type                   | varchar(20)   | NO   | SELECT    | MVPはSELECT固定 |
| sort_order                   | integer       | NO   | 10        | 表示順 |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- UNIQUE(tenant_id, item_attribute_code)
- CHECK(value_type IN ('SELECT'))

---

## 3. item_attribute_values（品目仕様属性値）

### 仕様概要
- 仕様属性の選択肢（例：色=赤/青、サイズ=S/M/L）。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | IAV-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| item_attribute_id            | uuid          | NO   | IAT-...   | FK→item_attributes |
| value_code                   | varchar(30)   | NO   | RED       | 変更原則禁止 |
| value_name                   | varchar(100)  | NO   | 赤        | |
| sort_order                   | integer       | NO   | 10        | 表示順 |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- FK(tenant_id, item_attribute_id) → item_attributes(tenant_id, id)
- UNIQUE(tenant_id, item_attribute_id, value_code)

---

## 4. item_variants（SKU）

### 仕様概要
- 1品目内のSKU（仕様組合せ）を表す。
- `variant_code` は品目内で一意。`00000` は基底SKU（標準SKU）として予約。
- 仕様組合せの一意性は `variant_signature`（ハッシュ）で担保する（I-005 対応）。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | VAR-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| item_id                      | uuid          | NO   | ITM-...   | FK→items |
| variant_code                 | varchar(5)    | NO   | 00000     | 品目内連番（5桁） |
| variant_name                 | varchar(200)  | NO   | 標準      | 表示用（自動生成可） |
| variant_signature            | varchar(64)   | NO   | 1f2e...   | 仕様組合せの正規化ハッシュ（sha256 hex想定） |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- FK(tenant_id, item_id) → items(tenant_id, id)
- UNIQUE(tenant_id, item_id, variant_code)
- UNIQUE(tenant_id, item_id, variant_signature)
- CHECK(variant_code ~ '^\d{5}$')
- CHECK(
    (variant_code = '00000' AND variant_signature = '')
 OR (variant_code <> '00000' AND variant_signature <> '')
  )

### 補足（variant_signature の生成）
- SKU登録時に、`item_variant_attributes` の属性値ペアを **属性ID順でソート**し、次の正規化文字列を作る：
  - `"{item_attribute_id}:{item_attribute_value_id}|{item_attribute_id}:{item_attribute_value_id}|..."`
- その文字列の sha256 を hex 文字列で `variant_signature` に格納する。
  → DBの UNIQUE(tenant_id, item_id, variant_signature) により、同一組合せの重複SKUを物理的に防止できる。

---

## 5. item_variant_attributes（SKU仕様：属性×値）

### 仕様概要
- SKUに紐づく「仕様属性」と「仕様属性値」を保持する（SKU確定の中核）。
- 1SKU内で同一属性は重複不可。

### エンティティ定義

| カラム                         | 型            | NULL | 例        | 補足 |
|------------------------------|---------------|------|-----------|------|
| id                           | uuid          | NO   | IVA-...   | PK |
| tenant_id                    | uuid          | NO   | TEN-...   | RLS |
| item_variant_id              | uuid          | NO   | VAR-...   | FK→item_variants |
| item_attribute_id            | uuid          | NO   | IAT-...   | FK→item_attributes |
| item_attribute_value_id      | uuid          | NO   | IAV-...   | FK→item_attribute_values |
| is_active                    | boolean       | NO   | true      | 論理無効 |
| created_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| created_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |
| updated_at                   | timestamptz   | NO   | 2026-01-01T00:00:00Z | |
| updated_by_login_account_id  | uuid          | NO   | ACC-...   | FK→login_accounts |

### 制約条件
- FK(tenant_id, item_variant_id) → item_variants(tenant_id, id)
- FK(tenant_id, item_attribute_id) → item_attributes(tenant_id, id)
- FK(tenant_id, item_attribute_value_id) → item_attribute_values(tenant_id, id)
- UNIQUE(tenant_id, item_variant_id, item_attribute_id)

### 補足（属性値の整合）
- `item_attribute_value_id` が `item_attribute_id` に属することは、MVPでは **アプリ層で検証**する。
  （V2で必要になれば、`item_attribute_values` に対して `(tenant_id, item_attribute_id, id)` の複合一意 + 複合FKでDB担保も可能）

---

以上。
