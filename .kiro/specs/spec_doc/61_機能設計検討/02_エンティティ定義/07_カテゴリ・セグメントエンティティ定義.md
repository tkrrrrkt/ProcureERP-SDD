# カテゴリ・セグメント（軸と値） エンティティ定義
---

## 1. CategoryAxis（カテゴリ：軸）

### ■ 仕様概要
分類・グルーピング・分析のための「軸」を定義するマスタ。
カテゴリ（軸）はテナントが自由に作成できる。
ただしカテゴリ（軸）は対象マスタ種別を1つだけ持ち、他種別への流用は禁止する。

### ■ エンティティ定義
| 項目 | 内容 |
|---|---|
| id | UUID（PK） |
| tenant_id | テナントID |
| axis_code | 軸コード（業務コード） |
| axis_name | 軸名称 |
| target_entity_kind | 対象マスタ種別（enum） |
| supports_hierarchy | 階層有無（boolean） |
| description | 説明（任意） |
| is_active | 有効フラグ |

### ■ 制約条件
- UNIQUE(tenant_id, axis_code)
- target_entity_kind は以下のいずれか  
  - ITEM / PARTY / SUPPLIER_SITE
- supports_hierarchy の制約  
  - target_entity_kind = ITEM の場合のみ true を許可  
  - target_entity_kind ≠ ITEM の場合は false 固定
- 物理削除禁止（is_active=false による論理無効化）

### ■ 補足
- マスタ種別ごとにカテゴリ（軸）は複数作成可能。
- 対象マスタ種別の流用は禁止（例：品目用軸を取引先に使わない）。

---

## 2. Segment（セグメント：軸の値）

### ■ 仕様概要
カテゴリ（軸）に紐づく「値（Member）」を定義するマスタ。
品目用カテゴリ（軸）のみ、階層（親子）を持てる。

### ■ エンティティ定義
| 項目 | 内容 |
|---|---|
| id | UUID（PK） |
| tenant_id | テナントID |
| category_axis_id | CategoryAxis ID（FK） |
| segment_code | 値コード（業務コード） |
| segment_name | 値名称 |
| parent_segment_id | 親セグメントID（FK, NULL可） |
| display_order | 表示順（任意） |
| description | 説明（任意） |
| is_active | 有効フラグ |

### ■ 制約条件
- UNIQUE(tenant_id, category_axis_id, segment_code)
- parent_segment_id の制約  
  - CategoryAxis.supports_hierarchy = false の場合、parent_segment_id は NULL 固定  
  - CategoryAxis.supports_hierarchy = true の場合のみ parent_segment_id を許可
- 循環参照は禁止（親子がループしないこと）
- 物理削除禁止（is_active=false による論理無効化）

### ■ 補足
- 階層は品目カテゴリ（ITEM対象の軸）のみ利用可能。
- PARTY / SUPPLIER_SITE 対象の軸では parent_segment_id は常に NULL（フラット運用）。

---

## 3. SegmentAssignment（割当：エンティティ×軸→値）

### ■ 仕様概要
任意のエンティティ（品目・取引先法人・仕入先拠点）に対し、
カテゴリ（軸）とセグメント（値）を割り当てるための関連エンティティ。
「1軸につき1値」の割当制約を持つ。

### ■ エンティティ定義
| 項目 | 内容 |
|---|---|
| id | UUID（PK） |
| tenant_id | テナントID |
| entity_kind | 対象エンティティ種別（enum） |
| entity_id | 対象エンティティID（UUID） |
| category_axis_id | CategoryAxis ID（FK） |
| segment_id | Segment ID（FK） |
| is_active | 有効フラグ |
| created_at | 作成日時 |
| updated_at | 更新日時 |

### ■ 制約条件
- 1軸につき1値（確定）  
  - UNIQUE(tenant_id, entity_kind, entity_id, category_axis_id)
- entity_kind は拡張可能な enum とするが、MVPの対象は以下に限定する  
  - ITEM / PARTY / SUPPLIER_SITE
- 軸の対象種別一致（確定）  
  - entity_kind は category_axis.target_entity_kind と一致しなければならない
- segment は必ず category_axis と整合する  
  - segment.category_axis_id = category_axis_id
- 物理削除禁止（is_active=false による論理無効化）
- `entity_kind` + `entity_id` の参照整合性は polymorphic のためDBのFKで担保できない。
  - 登録/更新時にアプリ層で「entity_kindに応じた対象テーブルにentity_idが存在すること」を必須検証する。
  - 併せて nightly batch で整合性監査（欠損・不整合の検出）を行い、検出時はアラート＋運用ポリシーに従い無効化/修復を実施する。

### ■ 補足
- 将来、PO_LINE等のトランザクションへ割当を拡張する場合は、
  そのトランザクション専用のカテゴリ（軸）を新規作成して割当する（軸の流用は禁止）。

---

以上。
