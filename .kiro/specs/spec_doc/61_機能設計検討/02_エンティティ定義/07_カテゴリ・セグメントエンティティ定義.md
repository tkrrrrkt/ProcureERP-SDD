# カテゴリ・セグメント（軸と値） エンティティ定義

## 0. 共通仕様
- 物理削除禁止：is_active=false により論理無効化
- 監査カラム：created_at / updated_at / created_by_login_account_id / updated_by_login_account_id
- 楽観ロック：version カラムによる排他制御
- UUID：全エンティティでPK（id）として保持

---

## 1. CategoryAxis（カテゴリ：軸）

### ■ 仕様概要
分類・グルーピング・分析のための「軸」を定義するマスタ。
カテゴリ（軸）はテナントが自由に作成できる。
ただしカテゴリ（軸）は対象マスタ種別を1つだけ持ち、他種別への流用は禁止する。

### ■ エンティティ定義
| 項目 | 型 | NULL | 説明 |
|---|---|:---:|---|
| id | UUID | NO | 正本PK |
| tenant_id | UUID | NO | テナントID（RLS境界） |
| axis_code | VARCHAR(10) | NO | 軸コード（業務コード） |
| axis_name | VARCHAR(100) | NO | 軸名称 |
| target_entity_kind | TEXT(enum) | NO | 対象マスタ種別（ITEM/PARTY/SUPPLIER_SITE） |
| supports_hierarchy | BOOLEAN | NO | 階層有無（ITEMのみtrue可） |
| display_order | INT | NO | 表示順（default: 1000） |
| description | TEXT | YES | 説明（任意） |
| is_active | BOOLEAN | NO | 有効フラグ（default: true） |
| version | INT | NO | 楽観ロック用（default: 1） |
| created_at | TIMESTAMPTZ | NO | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | 更新日時 |
| created_by_login_account_id | UUID | YES | 作成者 |
| updated_by_login_account_id | UUID | YES | 更新者 |

### ■ 制約条件
- PRIMARY KEY (id)
- UNIQUE (tenant_id, axis_code)
- CHECK (target_entity_kind IN ('ITEM', 'PARTY', 'SUPPLIER_SITE'))
- CHECK (supports_hierarchy = false OR target_entity_kind = 'ITEM')
  - ITEMの場合のみ supports_hierarchy = true を許可
- INDEX (tenant_id, axis_code)
- INDEX (tenant_id, target_entity_kind)
- INDEX (tenant_id, display_order)
- INDEX (tenant_id, is_active)

### ■ 補足
- マスタ種別ごとにカテゴリ（軸）は複数作成可能。
- 対象マスタ種別の流用は禁止（例：品目用軸を取引先に使わない）。

---

## 2. Segment（セグメント：軸の値）

### ■ 仕様概要
カテゴリ（軸）に紐づく「値（Member）」を定義するマスタ。
品目用カテゴリ（軸）のみ、階層（親子）を持てる。

### ■ エンティティ定義
| 項目 | 型 | NULL | 説明 |
|---|---|:---:|---|
| id | UUID | NO | 正本PK |
| tenant_id | UUID | NO | テナントID（RLS境界） |
| category_axis_id | UUID | NO | CategoryAxis ID（FK） |
| segment_code | VARCHAR(10) | NO | 値コード（業務コード） |
| segment_name | VARCHAR(100) | NO | 値名称 |
| parent_segment_id | UUID | YES | 親セグメントID（FK, 階層有効時のみ） |
| hierarchy_level | INT | NO | 階層レベル（default: 1, root=1） |
| hierarchy_path | TEXT | YES | 階層パス（例: /parent-id/child-id/） |
| display_order | INT | NO | 表示順（default: 1000） |
| description | TEXT | YES | 説明（任意） |
| is_active | BOOLEAN | NO | 有効フラグ（default: true） |
| version | INT | NO | 楽観ロック用（default: 1） |
| created_at | TIMESTAMPTZ | NO | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | 更新日時 |
| created_by_login_account_id | UUID | YES | 作成者 |
| updated_by_login_account_id | UUID | YES | 更新者 |

### ■ 制約条件
- PRIMARY KEY (id)
- UNIQUE (tenant_id, category_axis_id, segment_code)
- FK (category_axis_id) → category_axes(id)
- FK (parent_segment_id) → segments(id)
- INDEX (tenant_id, category_axis_id)
- INDEX (tenant_id, category_axis_id, display_order)
- INDEX (tenant_id, category_axis_id, is_active)
- INDEX (tenant_id, hierarchy_path) — 階層検索用

### ■ 階層制約（アプリ層で担保）
- parent_segment_id の制約
  - CategoryAxis.supports_hierarchy = false の場合、parent_segment_id は NULL 固定
  - CategoryAxis.supports_hierarchy = true の場合のみ parent_segment_id を許可
- 循環参照は禁止（親子がループしないこと）
- hierarchy_level / hierarchy_path はアプリ層で計算・設定

### ■ 補足
- 階層は品目カテゴリ（ITEM対象の軸）のみ利用可能。
- PARTY / SUPPLIER_SITE 対象の軸では parent_segment_id は常に NULL（フラット運用）。

---

## 3. SegmentAssignment（割当：エンティティ×軸→値）

### ■ 仕様概要
任意のエンティティ（品目・取引先法人・仕入先拠点）に対し、
カテゴリ（軸）とセグメント（値）を割り当てるための関連エンティティ。
「1軸につき1値」の割当制約を持つ。

### ■ エンティティ定義
| 項目 | 型 | NULL | 説明 |
|---|---|:---:|---|
| id | UUID | NO | 正本PK |
| tenant_id | UUID | NO | テナントID（RLS境界） |
| entity_kind | TEXT(enum) | NO | 対象エンティティ種別（ITEM/PARTY/SUPPLIER_SITE） |
| entity_id | UUID | NO | 対象エンティティID（polymorphic） |
| category_axis_id | UUID | NO | CategoryAxis ID（FK） |
| segment_id | UUID | NO | Segment ID（FK） |
| is_active | BOOLEAN | NO | 有効フラグ（default: true） |
| version | INT | NO | 楽観ロック用（default: 1） |
| created_at | TIMESTAMPTZ | NO | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | 更新日時 |
| created_by_login_account_id | UUID | YES | 作成者 |
| updated_by_login_account_id | UUID | YES | 更新者 |

### ■ 制約条件
- PRIMARY KEY (id)
- UNIQUE (tenant_id, entity_kind, entity_id, category_axis_id) — 1軸1値
- FK (category_axis_id) → category_axes(id)
- FK (segment_id) → segments(id)
- CHECK (entity_kind IN ('ITEM', 'PARTY', 'SUPPLIER_SITE'))
- INDEX (tenant_id, entity_kind, entity_id)
- INDEX (tenant_id, category_axis_id)
- INDEX (tenant_id, segment_id)

### ■ 整合性担保（アプリ層）
- entity_kind は category_axis.target_entity_kind と一致しなければならない
- segment.category_axis_id = category_axis_id であること
- `entity_kind` + `entity_id` の参照整合性は polymorphic のためDBのFKで担保できない
  - 登録/更新時にアプリ層で「entity_kindに応じた対象テーブルにentity_idが存在すること」を必須検証
  - nightly batch で整合性監査（欠損・不整合の検出）を行い、検出時はアラート＋運用ポリシーに従い無効化/修復

### ■ 補足
- 将来、PO_LINE等のトランザクションへ割当を拡張する場合は、
  そのトランザクション専用のカテゴリ（軸）を新規作成して割当する（軸の流用は禁止）。

---

以上。
