# 取引先・パートナードメイン定義

**最終更新**: 2025-12-14  
**対応する用語集**: `.kiro/specs/domain/glossary.md` - 「2. 取引先・パートナー」

---

## 1. ドメイン概要

取引先・パートナードメインは、調達管理SaaSにおける対外取引の相手先を管理するドメインです。  
顧客・仕入先・外注先など、すべての取引先を包括的に管理し、調達プロセスにおける基盤データを提供します。

### 1.1 ドメインの範囲

本ドメインは以下のエンティティを含みます：

- **取引先（Business Partner）** - 会社をユニークに特定するもの。対外取引の相手先の会社単位を表すオブジェクト
- **仕入先（Supplier）** - 発注などにおける取引相手の場所（a営業所、b営業所など先方の契約先）。取引先の営業所・拠点単位
- **仕入先品目（Supplier Item）** - 自社品目と仕入先品目の紐づけ
- **納入先（Ship-to Location）** - 納品物の配送先
- **支払先（Payee）** - 複数の仕入先を束ねて支払先コードとして管理し、仕入の計上をまとめて支払う場合に使う支払先
- **銀行口座（Bank Account）** - 仕入先の受取口座
- **連絡先担当者（Contact Person）** - 取引先に紐づく人の情報
- **支払条件（Payment Term）** - 支払条件の定義

---

## 2. コアエンティティ

### 2.1 取引先（Business Partner）

**定義**: 会社をユニークに特定するもの。顧客・仕入先・外注先など、対外取引の相手先の会社単位を表すオブジェクト。

**特徴**:
- 種別（Customer/Supplier/Both）で管理
- 1つの取引先に対して複数の仕入先（営業所・拠点）を紐づけ可能
- テナント・会社単位で管理

**主要属性**:
- 取引先コード（会社内一意）
- 取引先名（日本語・カナ・英字）
- 取引先グループコード（任意）
- ステータス（ACTIVE/INACTIVE）
- 適用開始日・適用終了日（履歴管理）

**ビジネスルール**:
- 取引先コードは会社内で一意であること
- ステータスがINACTIVEの場合、新規発注は不可
- 適用終了日が過去の場合、新規発注は不可

---

### 2.2 仕入先（Supplier）

**定義**: 発注などにおける取引相手の場所（a営業所、b営業所など先方の契約先）。取引先の営業所・拠点単位を表す。支払条件・通貨・銀行口座・担当者情報を持つ。

**特徴**:
- 取引先（Business Partner）を親として持つ
- 1つの取引先に対して複数の仕入先（営業所・拠点）を紐づけ可能
- 発注停止フラグで一時的な発注停止を管理
- 支払先に紐づけ可能（複数の仕入先を1つの支払先に束ねて支払管理）

**主要属性**:
- 仕入先コード（会社内一意、営業所・拠点ごとに付与）
- 仕入先名（日本語・カナ）
- 住所情報（郵便番号・都道府県・市区町村・住所1・住所2）
- 電話番号
- 既定通貨（ISO 4217）
- 海外フラグ
- 税計算方式（LINE/DOCUMENT）
- 既定税区分・返品税区分
- 発注停止フラグ・発注停止理由・発注停止期間
- 支払先ID（複数の仕入先を束ねる支払先への参照、任意）

**ビジネスルール**:
- 仕入先コードは会社内で一意であること
- 発注停止フラグがtrueの場合、新規発注は不可
- 発注停止期間外の場合、発注停止フラグは自動的にfalseになる
- 既定通貨はISO 4217に準拠すること

---

### 2.3 仕入先品目（Supplier Item）

**定義**: 自社の品目／SKUに対して、仕入先が管理している品番・品名・発注単位を紐づけたもの。

**特徴**:
- 自社品目と仕入先品目のマッピング
- 1仕入先×1品目で複数の発注単位・荷姿を持つ場合もある
- 発注時のデフォルト情報として利用

**主要属性**:
- 仕入先ID
- 品目ID（またはSKU ID）
- 仕入先品番
- 仕入先品名
- 発注単位
- 入り数（1パックあたりの数量）
- 標準単価（任意）

**ビジネスルール**:
- 1仕入先×1品目で複数の発注単位を登録可能
- 発注単位は在庫基準単位と異なる場合がある（例：1ケース=20個）

---

### 2.4 納入先（Ship-to Location）

**定義**: 納品物の配送先。自社倉庫・自社工場・得意先の現場・工事現場などを含む。

**特徴**:
- 発注時点で「どこに届けるか」を指定するためのマスタ
- 自社向け納入の場合は、自社倉庫や自社工場を納入先として登録
- 会社・部門と紐づけ可能

**主要属性**:
- 納入先コード（会社内一意）
- 納入先名
- 住所情報
- 連絡先情報
- 会社ID・部門ID（任意）

**ビジネスルール**:
- 納入先コードは会社内で一意であること
- 自社向け納入の場合は、会社・部門と紐づける

---

### 2.5 支払先（Payee）

**定義**: 複数の仕入先を束ねて支払先コードとして管理し、仕入の計上をまとめて支払う場合に使う支払先。請求書の宛先としても利用する。

**特徴**:
- 複数の仕入先を1つの支払先に束ねて管理
- 仕入計上をまとめて支払う場合に利用
- 請求書の宛先として利用
- インボイス番号（適格請求書番号）を持つ

**主要属性**:
- 支払先コード（会社内一意）
- 支払先名
- インボイス番号（適格請求書番号）
- 会社ID・部門ID（必要に応じて）
- 住所情報（請求書の宛先情報）
- 支払条件（支払先単位で設定可能）

**ビジネスルール**:
- 支払先コードは会社内で一意であること
- 1つの支払先に対して複数の仕入先を紐づけ可能
- インボイス番号は適格請求書番号の形式に準拠すること
- 仕入計上時に支払先を指定することで、複数の仕入先からの仕入をまとめて支払管理できる

---

### 2.6 銀行口座（Bank Account）

**定義**: 仕入先の受取口座。通貨・口座種別・名義を含む。支払データ連携の紐づけに利用。

**特徴**:
- 仕入先に紐づく
- 複数の銀行口座を登録可能（通貨ごとなど）
- 支払データ連携の紐づけに利用

**主要属性**:
- 仕入先ID
- 銀行コード・支店コード
- 口座種別（普通・当座など）
- 口座番号
- 口座名義
- 通貨（ISO 4217）
- 優先順位（複数口座がある場合の優先順）

**ビジネスルール**:
- 1仕入先に対して複数の銀行口座を登録可能
- 通貨ごとに優先順位を設定可能

---

### 2.7 連絡先担当者（Contact Person）

**定義**: 取引先に紐づく人の情報。購買担当・営業担当など。メールアドレス・電話番号を持つ。

**特徴**:
- 取引先または仕入先に紐づく
- 複数の担当者を登録可能
- 役割（購買担当・営業担当など）を管理

**主要属性**:
- 取引先ID（または仕入先ID）
- 担当者名
- 役割（購買担当・営業担当など）
- メールアドレス
- 電話番号
- 優先順位（複数担当者がある場合の優先順）

**ビジネスルール**:
- 1取引先（または仕入先）に対して複数の担当者を登録可能
- 役割ごとに優先順位を設定可能

---

### 2.8 支払条件（Payment Term）

**定義**: 支払条件の定義。締日・支払日・支払月繰りなどを管理。

**特徴**:
- 会社単位で管理
- 発注時のデフォルト支払条件として利用
- 支払データ連携の紐づけに利用

**主要属性**:
- 支払条件コード（会社内一意）
- 名称（例：末締翌月末）
- 説明
- 締日（1-31 / 99=月末）
- 支払日（1-31 / 99=月末）
- 支払月繰り（0-3、例：翌月=1）

**ビジネスルール**:
- 支払条件コードは会社内で一意であること
- 締日・支払日は1-31または99（月末）であること

---

## 3. エンティティ間の関係

### 3.1 取引先と仕入先の関係

```
取引先（Business Partner）
  └─ 仕入先（Supplier）[1:多]
      ├─ 仕入先品目（Supplier Item）[1:多]
      ├─ 銀行口座（Bank Account）[1:多]
      └─ 連絡先担当者（Contact Person）[1:多]
```

**関係の特徴**:
- 1つの取引先に対して複数の仕入先（拠点）を紐づけ可能
- 仕入先は必ず1つの取引先に紐づく
- 仕入先は取引先の種別が「Supplier」または「Both」である必要がある

---

### 3.2 仕入先と納入先・支払先の関係

```
仕入先（Supplier）
  ├─ 納入先（Ship-to Location）[多:多]（発注時に指定）
  └─ 支払先（Payee）[多:1]（複数の仕入先を束ねて支払管理）

支払先（Payee）
  └─ 仕入先（Supplier）[1:多]（この支払先に紐づく仕入先の集合）
```

**関係の特徴**:
- 1つの仕入先に対して複数の納入先を指定可能
- 1つの支払先に対して複数の仕入先を紐づけ可能（多:1の関係）
- 複数の仕入先からの仕入計上を1つの支払先にまとめて支払管理できる
- 納入先は会社・部門と紐づけ可能
- 仕入先は支払先に紐づけなくても発注・仕入計上は可能（支払先は任意）

---

## 4. ビジネスルール

### 4.1 取引先の管理

1. **取引先コードの一意性**
   - 取引先コードは会社内で一意であること
   - 同一会社内で重複は不可

2. **ステータス管理**
   - ステータスがINACTIVEの場合、新規発注は不可
   - 適用終了日が過去の場合、新規発注は不可

3. **種別管理**
   - 種別が「Customer」のみの場合、仕入先として利用不可
   - 種別が「Supplier」または「Both」の場合、仕入先として利用可能

---

### 4.2 仕入先の管理

1. **仕入先コードの一意性**
   - 仕入先コードは会社内で一意であること
   - 同一会社内で重複は不可

2. **発注停止管理**
   - 発注停止フラグがtrueの場合、新規発注は不可
   - 発注停止期間外の場合、発注停止フラグは自動的にfalseになる
   - 発注停止理由は必須（発注停止フラグがtrueの場合）

3. **税計算方式**
   - LINE: 明細ごとに税額を計算
   - DOCUMENT: 文書単位で税額を計算

---

### 4.3 仕入先品目の管理

1. **マッピングの一意性**
   - 1仕入先×1品目で複数の発注単位を登録可能
   - 発注単位ごとに異なる仕入先品番を登録可能

2. **発注時の利用**
   - 発注時に仕入先品目を指定すると、仕入先品番・発注単位・入り数が自動設定される

---

### 4.4 支払先の管理

1. **支払先コードの一意性**
   - 支払先コードは会社内で一意であること
   - 同一会社内で重複は不可

2. **仕入先との関係**
   - 1つの支払先に対して複数の仕入先を紐づけ可能
   - 仕入先は支払先に紐づけなくても発注・仕入計上は可能（支払先は任意）
   - 複数の仕入先からの仕入計上を1つの支払先にまとめて支払管理できる

3. **インボイス番号**
   - インボイス番号は適格請求書番号の形式に準拠すること

---

## 5. 値オブジェクト

### 5.1 取引先種別（Business Partner Type）

**定義**: 取引先の種別を表す値オブジェクト。

**値**:
- `CUSTOMER` - 顧客のみ
- `SUPPLIER` - 仕入先のみ
- `BOTH` - 顧客と仕入先の両方

---

### 5.2 税計算方式（Tax Build-up Type）

**定義**: 税額計算の方式を表す値オブジェクト。

**値**:
- `LINE` - 明細ごとに税額を計算
- `DOCUMENT` - 文書単位で税額を計算

---

### 5.3 ステータス（Status）

**定義**: エンティティの有効性を表す値オブジェクト。

**値**:
- `ACTIVE` - 有効
- `INACTIVE` - 無効

---

## 6. ドメインイベント（将来拡張）

以下のドメインイベントを将来実装する可能性があります：

- `BusinessPartnerCreated` - 取引先が作成された
- `BusinessPartnerDeactivated` - 取引先が無効化された
- `SupplierCreated` - 仕入先が作成された
- `SupplierOnHold` - 仕入先が発注停止された
- `SupplierReleased` - 仕入先の発注停止が解除された

---

## 7. 参考資料

- ドメイン用語集: `.kiro/specs/domain/glossary.md` - 「2. 取引先・パートナー」
- レガシーエンティティ定義:
  - `.kiro/specs/domain/entities/legacy/business_partner.md`
  - `.kiro/specs/domain/entities/legacy/supplier.md`
  - `.kiro/specs/domain/entities/legacy/payment_term.md`
  - `.kiro/specs/domain/entities/legacy/ship_to.md`

---

## 8. 実装時の注意事項

### 8.1 Prismaスキーマ設計

- 取引先（Business Partner）と仕入先（Supplier）は1:多の関係
- 仕入先は必ず1つの取引先に紐づく（`partner_id` は必須）
- テナント・会社単位でデータ分離（`tenant_id`, `company_id` は必須）

### 8.2 データ整合性

- 取引先の種別が「Supplier」または「Both」の場合のみ、仕入先を紐づけ可能
- 発注停止期間外の場合、発注停止フラグは自動的にfalseになる（バッチ処理またはトリガー）

### 8.3 パフォーマンス

- 取引先コード・仕入先コードにはインデックスを設定
- 発注停止フラグがtrueの仕入先の検索を高速化するため、インデックスを設定

---

## 9. 今後の拡張予定

### 9.1 MVP以降の拡張

- 顧客（Customer）の詳細管理
- 外注先（Subcontractor）の詳細管理
- サプライヤースコアカードとの連携
- 取引先グループのマスタ化

### 9.2 外部連携

- 会計システムとの連携（支払データ連携）
- 基幹システムとの連携（取引先マスタ同期）

