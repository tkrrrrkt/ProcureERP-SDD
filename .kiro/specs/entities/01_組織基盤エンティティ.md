# ProcureERP 組織基盤エンティティ定義

> 本ドキュメントは EPM-UIMOCK の設計を参照し、ProcureERP 向けにシンプル化したものである。

---

## 0. 設計思想

### 0.1 境界（RLS）

- **tenant_id がデータ分離境界**（全テーブルに tenant_id を持たせる）
- RLS（Row Level Security）を有効化し、tenant_id でアクセス制御

### 0.2 組織：版と不変ID

- 組織は **organization_versions（版）** でスナップショット管理
- 部門は版内の実体 `departments.id` と、版を跨ぐ追跡キー `departments.stable_id` を併用
  - UI操作・入力は department_id（版内実体）
  - 時系列比較・所属履歴は department_stable_id（版非依存）

### 0.3 ProcureERP での簡略化

EPM-UIMOCK と比較して以下を簡略化：

| 項目 | EPM-UIMOCK | ProcureERP |
|------|-----------|------------|
| company_id | 必須（複数会社対応） | 省略（単一会社前提、tenant = company） |
| 承認者カラム | approver_1〜5 + deputy | 省略（V1では不要） |
| 組織ディメンション | dimensions連携 | 省略 |
| headcount | 自動計算 | 省略（V1では不要） |

---

## 1. organization_versions（組織バージョン）

### 1.1 仕様

- 組織をスナップショット（版）として管理
- effective_date / expiry_date で有効期間を管理
- as-of検索で対象日時点の有効版を取得可能

### 1.2 エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|-----|------|-----|------|
| id | uuid | NO | OV-2025-04 | PK |
| tenant_id | uuid | NO | T-ABC | RLS境界 |
| version_code | varchar(20) | NO | "2025-04" | テナント内一意 |
| version_name | varchar(200) | NO | "2025年4月組織改編" | 表示名 |
| effective_date | date | NO | 2025-04-01 | 有効開始日 |
| expiry_date | date | YES | 2025-10-01 | 有効終了日（NULL=無期限） |
| base_version_id | uuid | YES | OV-2024-04 | コピー元バージョン |
| description | text | YES | | 備考 |
| is_active | boolean | NO | true | 論理削除フラグ |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |
| created_by | uuid | YES | | 監査 |
| updated_by | uuid | YES | | 監査 |

### 1.3 制約

- PK: id
- UNIQUE(tenant_id, version_code)
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)

### 1.4 インデックス

- idx_org_versions_tenant_effective: (tenant_id, effective_date)
- idx_org_versions_tenant_code: (tenant_id, version_code)

---

## 2. departments（部門マスタ）

### 2.1 仕様

- 版内実体（id）と版非依存の追跡キー（stable_id）を併用
- 階層構造は parent_id で管理（自己参照）
- hierarchy_path / hierarchy_level はキャッシュ（移動時に再計算）
- 部門の住所情報を保持可能

### 2.2 エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|-----|------|-----|------|
| id | uuid | NO | D-... | PK（版内実体） |
| tenant_id | uuid | NO | T-ABC | RLS境界 |
| version_id | uuid | NO | OV-... | FK → organization_versions |
| stable_id | uuid | NO | S-SALES | 版非依存の追跡キー |
| department_code | varchar(50) | NO | "SALES_HQ" | 版内一意 |
| department_name | varchar(200) | NO | "営業本部" | 部門名 |
| department_name_short | varchar(100) | YES | "営業" | 略称 |
| parent_id | uuid | YES | | 親部門ID（同版内のみ） |
| sort_order | int | NO | 10 | 表示順 |
| hierarchy_level | int | NO | 2 | 階層レベル（キャッシュ） |
| hierarchy_path | varchar(1000) | YES | "/ROOT/SALES_HQ" | 階層パス（キャッシュ） |
| is_active | boolean | NO | true | 有効フラグ |
| postal_code | varchar(10) | YES | "100-0001" | 郵便番号 |
| address_line1 | varchar(200) | YES | "東京都千代田区..." | 住所1（都道府県・市区町村） |
| address_line2 | varchar(200) | YES | "○○ビル 5F" | 住所2（建物名等） |
| phone_number | varchar(20) | YES | "03-1234-5678" | 電話番号 |
| description | text | YES | | 備考 |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |
| created_by | uuid | YES | | 監査 |
| updated_by | uuid | YES | | 監査 |

### 2.3 制約

- PK: id
- UNIQUE(tenant_id, version_id, department_code)
- UNIQUE(tenant_id, stable_id) - テナント内でstable_idは一意
- FK(tenant_id, version_id) → organization_versions(tenant_id, id)
- FK(parent_id) → departments(id) - 同版内のみ（UseCase検証）
- cycleチェック（UseCase必須）

### 2.4 インデックス

- idx_departments_tenant_version: (tenant_id, version_id)
- idx_departments_tenant_stable: (tenant_id, stable_id)
- idx_departments_parent: (tenant_id, version_id, parent_id)
- idx_departments_path: (tenant_id, hierarchy_path)

### 2.5 補足

- **stable_id**: 版を跨ぐ追跡キー。新版作成時にコピー元と同じstable_idを引き継ぐ
- **hierarchy_path**: `/ROOT/SALES_HQ/TEAM1` 形式。部門移動・コード変更後は再計算が必要
- **hierarchy_level**: ルート=1、子=親+1。キャッシュとして保持
- **住所情報**: 部門ごとの所在地を管理。親部門の住所を継承する運用も可能（UIで対応）

---

## 3. employees（社員マスタ）

### 3.1 仕様

- 「社員という人」を表す不変に近い実体
- 異動・兼務・役職は employee_assignments で管理

### 3.2 エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|-----|------|-----|------|
| id | uuid | NO | E-... | PK |
| tenant_id | uuid | NO | T-... | RLS境界 |
| employee_code | varchar(30) | NO | "A00123" | テナント内一意 |
| employee_name | varchar(100) | NO | "山田 太郎" | 氏名 |
| employee_name_kana | varchar(100) | YES | "ヤマダ タロウ" | カナ名 |
| email | varchar(255) | YES | "taro@..." | メールアドレス |
| hire_date | date | YES | 2020-04-01 | 入社日 |
| leave_date | date | YES | 2026-03-31 | 退職日 |
| is_active | boolean | NO | true | 有効フラグ |
| version | int | NO | 1 | 楽観ロック |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |
| created_by | uuid | YES | | 監査 |
| updated_by | uuid | YES | | 監査 |

### 3.3 制約

- PK: id
- UNIQUE(tenant_id, employee_code)

### 3.4 インデックス

- idx_employees_tenant_code: (tenant_id, employee_code)
- idx_employees_tenant_active: (tenant_id, is_active)

---

## 4. employee_assignments（社員所属履歴）

### 4.1 仕様

- いつ・どの部門に・どう所属したか（主務/兼務、按分）を管理
- 部門は **department_stable_id** で接続（組織改編耐性）

### 4.2 エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|-----|------|-----|------|
| id | uuid | NO | EA-... | PK |
| tenant_id | uuid | NO | T-... | RLS境界 |
| employee_id | uuid | NO | E-... | FK → employees |
| department_stable_id | uuid | NO | S-SALES | 部門stable_id |
| assignment_type | varchar(20) | NO | "primary" | primary/secondary |
| allocation_ratio | numeric(5,2) | YES | 70.00 | 按分率（任意） |
| title | varchar(100) | YES | "課長" | 役職 |
| effective_date | date | NO | 2025-04-01 | 開始日 |
| expiry_date | date | YES | 2025-10-01 | 終了日（NULL=無期限） |
| is_active | boolean | NO | true | 有効フラグ |
| version | int | NO | 1 | 楽観ロック |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |
| created_by | uuid | YES | | 監査 |
| updated_by | uuid | YES | | 監査 |

### 4.3 制約

- PK: id
- CHECK(assignment_type IN ('primary', 'secondary'))
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)
- FK(tenant_id, employee_id) → employees(tenant_id, id)

### 4.4 インデックス

- idx_assignments_tenant_employee: (tenant_id, employee_id)
- idx_assignments_tenant_stable: (tenant_id, department_stable_id)
- idx_assignments_effective: (tenant_id, effective_date)

### 4.5 補足

- **department_stable_id**: departments.stable_id を参照。組織改編してもデータが追跡可能
- **主務重複禁止**: 同一社員・同時期の primary は1つのみ（UseCase or EXCLUDE制約）
- **allocation_ratio**: 按分率。合計100%運用は任意

---

## 5. DDL（PostgreSQL）

```sql
-- ============================================
-- organization_versions（組織バージョン）
-- ============================================
CREATE TABLE organization_versions (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id       UUID NOT NULL,
    version_code    VARCHAR(20) NOT NULL,
    version_name    VARCHAR(200) NOT NULL,
    effective_date  DATE NOT NULL,
    expiry_date     DATE,
    base_version_id UUID,
    description     TEXT,
    is_active       BOOLEAN NOT NULL DEFAULT TRUE,
    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_by      UUID,
    updated_by      UUID,

    CONSTRAINT org_versions_tenant_code_unique UNIQUE (tenant_id, version_code),
    CONSTRAINT org_versions_date_check CHECK (expiry_date IS NULL OR expiry_date > effective_date)
);

ALTER TABLE organization_versions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "tenant_isolation" ON organization_versions
    FOR ALL USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

CREATE INDEX idx_org_versions_tenant_effective ON organization_versions(tenant_id, effective_date);
CREATE INDEX idx_org_versions_tenant_code ON organization_versions(tenant_id, version_code);

COMMENT ON TABLE organization_versions IS '組織バージョン（組織構造のスナップショット）';
COMMENT ON COLUMN organization_versions.version_code IS 'バージョンコード（例: 2025-04）';
COMMENT ON COLUMN organization_versions.effective_date IS '有効開始日';
COMMENT ON COLUMN organization_versions.expiry_date IS '有効終了日（NULL=無期限）';
COMMENT ON COLUMN organization_versions.base_version_id IS 'コピー元バージョンID';

-- ============================================
-- departments（部門マスタ）
-- ============================================
CREATE TABLE departments (
    id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id             UUID NOT NULL,
    version_id            UUID NOT NULL,
    stable_id             UUID NOT NULL,
    department_code       VARCHAR(50) NOT NULL,
    department_name       VARCHAR(200) NOT NULL,
    department_name_short VARCHAR(100),
    parent_id             UUID,
    sort_order            INT NOT NULL DEFAULT 0,
    hierarchy_level       INT NOT NULL DEFAULT 1,
    hierarchy_path        VARCHAR(1000),
    is_active             BOOLEAN NOT NULL DEFAULT TRUE,
    postal_code           VARCHAR(10),
    address_line1         VARCHAR(200),
    address_line2         VARCHAR(200),
    phone_number          VARCHAR(20),
    description           TEXT,
    created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_by            UUID,
    updated_by            UUID,

    CONSTRAINT depts_tenant_version_code_unique UNIQUE (tenant_id, version_id, department_code),
    CONSTRAINT depts_tenant_stable_unique UNIQUE (tenant_id, stable_id),
    CONSTRAINT depts_version_fkey FOREIGN KEY (tenant_id, version_id)
        REFERENCES organization_versions(tenant_id, id) ON DELETE CASCADE
);

ALTER TABLE departments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "tenant_isolation" ON departments
    FOR ALL USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

CREATE INDEX idx_departments_tenant_version ON departments(tenant_id, version_id);
CREATE INDEX idx_departments_tenant_stable ON departments(tenant_id, stable_id);
CREATE INDEX idx_departments_parent ON departments(tenant_id, version_id, parent_id);
CREATE INDEX idx_departments_path ON departments(tenant_id, hierarchy_path);

COMMENT ON TABLE departments IS '部門マスタ';
COMMENT ON COLUMN departments.stable_id IS '版非依存の追跡キー（組織改編を跨いで同一部門を識別）';
COMMENT ON COLUMN departments.hierarchy_path IS '階層パス（例: /ROOT/SALES_HQ/TEAM1）';
COMMENT ON COLUMN departments.hierarchy_level IS '階層レベル（ルート=1）';
COMMENT ON COLUMN departments.postal_code IS '郵便番号';
COMMENT ON COLUMN departments.address_line1 IS '住所1（都道府県・市区町村）';
COMMENT ON COLUMN departments.address_line2 IS '住所2（建物名等）';
COMMENT ON COLUMN departments.phone_number IS '電話番号';

-- ============================================
-- employees（社員マスタ）
-- ============================================
CREATE TABLE employees (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id           UUID NOT NULL,
    employee_code       VARCHAR(30) NOT NULL,
    employee_name       VARCHAR(100) NOT NULL,
    employee_name_kana  VARCHAR(100),
    email               VARCHAR(255),
    hire_date           DATE,
    leave_date          DATE,
    is_active           BOOLEAN NOT NULL DEFAULT TRUE,
    version             INT NOT NULL DEFAULT 1,
    created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_by          UUID,
    updated_by          UUID,

    CONSTRAINT employees_tenant_code_unique UNIQUE (tenant_id, employee_code)
);

ALTER TABLE employees ENABLE ROW LEVEL SECURITY;
CREATE POLICY "tenant_isolation" ON employees
    FOR ALL USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

CREATE INDEX idx_employees_tenant_code ON employees(tenant_id, employee_code);
CREATE INDEX idx_employees_tenant_active ON employees(tenant_id, is_active);

COMMENT ON TABLE employees IS '社員マスタ';
COMMENT ON COLUMN employees.employee_code IS '社員コード（テナント内一意）';
COMMENT ON COLUMN employees.version IS '楽観ロック用バージョン';

-- ============================================
-- employee_assignments（社員所属履歴）
-- ============================================
CREATE TABLE employee_assignments (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id               UUID NOT NULL,
    employee_id             UUID NOT NULL,
    department_stable_id    UUID NOT NULL,
    assignment_type         VARCHAR(20) NOT NULL,
    allocation_ratio        NUMERIC(5,2),
    title                   VARCHAR(100),
    effective_date          DATE NOT NULL,
    expiry_date             DATE,
    is_active               BOOLEAN NOT NULL DEFAULT TRUE,
    version                 INT NOT NULL DEFAULT 1,
    created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_by              UUID,
    updated_by              UUID,

    CONSTRAINT ea_assignment_type_check CHECK (assignment_type IN ('primary', 'secondary')),
    CONSTRAINT ea_date_check CHECK (expiry_date IS NULL OR expiry_date > effective_date),
    CONSTRAINT ea_employee_fkey FOREIGN KEY (tenant_id, employee_id)
        REFERENCES employees(tenant_id, id) ON DELETE CASCADE
);

ALTER TABLE employee_assignments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "tenant_isolation" ON employee_assignments
    FOR ALL USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

CREATE INDEX idx_assignments_tenant_employee ON employee_assignments(tenant_id, employee_id);
CREATE INDEX idx_assignments_tenant_stable ON employee_assignments(tenant_id, department_stable_id);
CREATE INDEX idx_assignments_effective ON employee_assignments(tenant_id, effective_date);

COMMENT ON TABLE employee_assignments IS '社員所属履歴';
COMMENT ON COLUMN employee_assignments.department_stable_id IS '部門stable_id（改編耐性のため版非依存キーで接続）';
COMMENT ON COLUMN employee_assignments.assignment_type IS '所属種別（primary:主務, secondary:兼務）';
COMMENT ON COLUMN employee_assignments.allocation_ratio IS '按分率（%）';
```

---

## 6. 設計決定ログ

| # | 検討項目 | 決定内容 | 決定理由 |
|---|---------|---------|---------|
| 1 | company_id | 省略（単一会社前提） | ProcureERPは単一テナント=単一会社運用を想定 |
| 2 | stable_id | 採用 | 組織改編を跨いだ部門追跡のため必須 |
| 3 | hierarchy_path | 採用 | 配下部門検索の高速化（LIKE '/ROOT/SALES/%'） |
| 4 | 承認者カラム | 省略 | V1では承認ワークフロー不要 |
| 5 | headcount | 省略 | V1では自動計算不要 |
| 6 | 楽観ロック | employees/assignments のみ | 頻繁に更新されるエンティティに適用 |
| 7 | org_unit_type | 省略 | V1では組織種別の分類不要 |
| 8 | manager_id | 省略 | V1では部門長の管理不要 |
| 9 | 部門住所 | 追加 | 部門ごとの所在地管理が必要（postal_code, address_line1/2, phone_number） |
| 10 | 共通監査項目 | 全エンティティ統一 | created_at, updated_at, created_by, updated_by を全テーブルに |

---

## 7. 改訂履歴

| 日付 | 版 | 変更内容 |
|------|-----|---------|
| 2026-01-18 | 1.0 | EPM-UIMOCKを参照して初版作成 |

---

以上。
